(e=>{"use strict";function t(e,t,r){o(this,{_id:{value:e._id||v()},[N]:{value:e[N]||{}},[j]:{value:e[j]||[]},[A]:{value:e[A]||[]},[E]:{value:e[E]||[]},_trendClear:{writable:!0,value:0}}),e._id||l(e,"_id",{value:this._id}),t&&o(this,{root:{value:t.root||t},host:{value:t},hostkey:{value:r}});let a=Object.keys(e);"array"===u(e)&&a.push("length");let n=new Proxy(this,I);return a.forEach(t=>{let{get:r,set:a,value:s}=Object.getOwnPropertyDescriptor(e,t);r||a?l(this,t,{get:r,set:a}):this[t]=U(s,n,t)}),n}let r=e.$,a=r.fn,n={};e.tagDatabase=n;const{assign:s,create:i,defineProperty:l,defineProperties:o}=Object;let h=e=>void 0!==e&&null!==e;const d=(e,t)=>{if(!e.getAttribute)return!1;let r=e.getAttribute(t);return null!==r&&void 0!==r||void 0};let c=Object.prototype.toString;const u=e=>c.call(e).toLowerCase().replace(/(\[object )|(])/g,""),p=(e,t)=>Array.from(e).forEach(t),v=()=>Math.random().toString(32).substr(2),f=((()=>{let e=!1,t=[]})(),v(),v()+"_xhearobj"),y=v()+"_attached",x=e=>{let t=e.tagName.toLowerCase();return n[t]},w=e=>{let t=e[f],r=i(t);return r.push(e),r},m=e=>1==e.length&&e[0][f]?w(e[0]):(e=>{let t=i(g);return t.splice(-1,0,...e),e.prevObject&&(t.prevObject=e.prevObject),t})(e),b=e=>{e.is("[xv-ele]")&&e.each((e,t)=>{_(t)}),r("[xv-ele]",Array.from(e)).each((e,t)=>{_(t)})};let g=i(a),k=100;const _=e=>{if(!d(e,"xv-ele"))return;let t=x(e);if(!t)return void console.warn("no exist tag",e);let a=r(e),n=Array.from(e.childNodes);e.innerHTML=t.temp;let i=++k,o=new t.XHear({}),c=new Proxy(o,I);e[f]=c;let p=w(e);a.removeAttr("xv-ele").attr("xv-render",i),a.find("*").attr("xv-shadow",i),r(`[xv-ele][xv-shadow="${i}"]`,e).each((e,t)=>{_(t)}),r(`xv-span[xv-shadow="${i}"]`,e).each((e,t)=>{var r=document.createTextNode("");t.parentNode.insertBefore(r,t),t.parentNode.removeChild(t);var a=t.getAttribute("svkey");c.watch(a,e=>{r.textContent=e})});let v=r(`[xv-content][xv-shadow="${i}"]`,e);if(0 in v&&(l(c,"$content",{enumerable:!0,get:()=>m(v)}),v.prop("svParent",e),v.append(n),t.childChange)){let r=new MutationObserver(r=>{r.forEach(r=>{let{addedNodes:a,removedNodes:n}=r,s={};0 in a&&(s.addedNodes=Array.from(a)),0 in n&&(s.removedNodes=Array.from(n)),t.childChange(w(e),s)})});r.observe(v[0],{attributes:!1,childList:!0,characterData:!1,subtree:!1}),c.__obs=r}r(`[xv-tar][xv-shadow="${i}"]`,e).each((e,t)=>{let a=r(t).attr("xv-tar");l(c,"$"+a,{enumerable:!0,get:()=>m([t])})});let b=s({},t.data);t.attrs.forEach(e=>{let t=a.attr(e);h(t)&&(b[e]=t),c.watch(e,t=>{a.attr(e,t)})}),t.props.forEach(e=>{let t=a.attr(e);h(t)&&(b[e]=t)}),r(`[xv-module][xv-shadow="${i}"]`,e).each((e,t)=>{let a=r(t),n=a.attr("xv-module");c.watch(n,e=>{t.value=e}),t[f]?t[f].watch("value",e=>{c[n]=e}):a.on("change input",e=>{c[n]=t.value})}),a.removeAttr("xv-ele").attr("xv-render",i);let g=t.watch;if(g)for(let e in g)e in b||(b[e]=void 0);if(o._exkeys=Object.keys(b),g)for(let e in g){let t,r,a=g[e];switch(u(a)){case"function":r=a;break;case"object":t=a.get,r=a.set}t&&watchGetter(c,e,t.bind(p)),r&&c.watch(e,r.bind(p))}l(e,"value",{get:()=>c.value,set(e){c.value=e}});for(let e in b)h(b[e])&&(c[e]=b[e]);t.inited&&t.inited.call(e,p),t.attached&&e.getRootNode()===document&&!e[y]&&(t.attached.call(e,p),e[y]=1)};let O=function(...e){let t=r(...e),[a,n]=e;("string"==u(a)&&a.search("<")>-1||a instanceof Element)&&b(t);let s;return n&&(n.getAttribute?s=n.getAttribute("xv-shadow"):n.attr&&(s=n.attr("xv-shadow"))),t=s?F(t,s):F(t),t=m(t)};O.prototype=a,s(O,{init:(...e)=>m(e)},r);const N="_events_"+v(),j="_syncs_"+v(),A="_trend_"+v(),E="_listen_"+v();let P,S=e=>e instanceof Object?JSON.parse(JSON.stringify(e)):e;(()=>{let e=[],t=0;P=(r=>{e.push(r),t||setTimeout(()=>{t=0;let r=e;e=[],r.forEach(e=>e())},5e3),t=1})})();const $=(e,t)=>{e[A].push(t),e._trendClear||(e._trendClear=1,P(()=>{e[A].length=0,e._trendClear=0}))},C=(e,t)=>l(e,"_inMethod",{configurable:!0,value:t}),M=(e,r,a)=>{let n=[];void 0===a?e.hasOwnProperty(r)&&n.push(e):e[r]==a&&n.push(e);for(let s in e){let i=e[s];if(i instanceof t){M(i,r,a).forEach(e=>{n.includes(e)||n.push(e)})}}return n},R=(e,t)=>{let r,a=t.keys.length-1;return t.keys.forEach((t,n)=>{n<a&&(e=e[t]),r=t}),[e,r]},T=(e,t)=>e[N][t]||(e[N][t]=[]),D=(e,t,r)=>{T(e,t).forEach(e=>{e(...r)})};let L=Object.create(Array.prototype);o(L,{string:{get(){return JSON.stringify(this)}},object:{get(){return S(this)}}}),t.prototype=L;let J={watch(e,t){let r=u(e);if("object"===r){for(let t in e)this.watch(t,e[t]);return this}return r.search("function")>-1&&(t=e,e=""),((e,t,r)=>T(e,t).push(r))(this,"watch-"+e,t),this},unwatch(e,t){let r=u(e);if("object"===r){for(let t in e)this.unwatch(t,e[t]);return this}return r.search("function")>-1&&(t=e,e=""),((e,t,r)=>{let a=T(e,t),n=a.indexOf(r);a.splice(n,1)})(this,"watch-"+e,t),this},reset(e){let t=Object.keys(e);return Object.keys(this).forEach(e=>{t.includes(e)||delete this[e]}),s(this,e),this},entrend(e){if(!e.tid)throw"trendData invalid";if(this[A].includes(e.tid))return;$(this,e.tid);let[t,r]=R(this,e),a=t.slice();switch(e.type){case"sort":C(this,"sort"),e.order.forEach((e,r)=>{t[e]=a[r]});break;case"delete":C(this,"delete"),delete t[r];break;case"array-method":let{methodName:n,args:s}=e;C(this,"array-"+n),Array.prototype[n].apply(t,s);break;default:C(this,"default"),t[r]=S(e.val)}return delete this._inMethod,this[j].forEach(t=>{t.func({trend:e})}),this},sync(e,t){let r,a;switch(u(t)){case"object":let n={};for(let e in t)n[t[e]]=e;r=(e=>{let t=S(e.trend),r=n[e.key];void 0!==r&&(t.keys[0]=r,this.entrend(t))}),a=(r=>{let a=S(r.trend),n=t[r.key];void 0!==n&&(a.keys[0]=n,e.entrend(a))});break;case"array":r=(e=>{t.includes(e.key)&&this.entrend(e.trend)}),a=(r=>{t.includes(r.key)&&e.entrend(r.trend)});break;case"string":r=(e=>{e.key===t&&this.entrend(e.trend)}),a=(r=>{r.key===t&&e.entrend(r.trend)});break;default:r=(e=>this.entrend(e.trend)),a=(t=>e.entrend(t.trend))}e.watch(r),this.watch(a);let n=v();return e[j].push({bid:n,options:t,opp:this,func:r}),this[j].push({bid:n,options:t,opp:e,func:a}),this},unsync(e,t){let r=this[j].findIndex(r=>r.opp===e&&r.options===t);if(r>-1){let t=this[j][r],a=e[j].findIndex(e=>e.bid===t.bid),n=e[j][a];this.unwatch(t.func),e.unwatch(n.func),this[j].splice(r,1),e[j].splice(a,1)}else console.log("not found =>",e);return this},seek(e){let t,r=e.match(/\[.+?\]/g);return r?r.forEach((e,r)=>{let[a,n]=e.replace(/[\[]|[\]]/g,"").split("="),s=M(this,a,n);if(0===r)t=s;else{let e=[];s.forEach(r=>{t.includes(r)&&e.push(r)}),t=e}}):t=M(this,"_id",e)[0],t},listen(e,t,r=10){let a;if(e){let n,s=JSON.stringify(this.seek(e).map(e=>e._id));this.watch(a=(a=>{let i=this.seek(e),l=i.map(e=>e._id);JSON.stringify(l)!==s&&(clearTimeout(n),n=setTimeout(()=>{t(i)},r))}))}else{let e;this.watch(a=(a=>{clearTimeout(e),e=setTimeout(()=>{t(tempData)},r)}))}return this[E].push({expr:e,callback:t,watchFunc:a}),this},unlisten(e,t){return this[E].forEach(r=>{if(r.expr===e&&r.callback===t){let{watchFunc:e}=r;this.unwatch(e)}}),this},transData(e){let t={key:"",target:"",targetKey:""};s(t,e);let{key:r,target:a,targetKey:n,trans:i}=t;if(t.trans){let e={};for(let t in i)e[i[t]]=t;this.watch(r,e=>{e=i[e],a[n]=e}),a.watch(n,t=>{t=e[t],this[r]=t})}},remove(...e){let[t]=e;0 in e?"number"===u(t)?this.splice(t,1):delete this[t]:this.host&&delete this.host[this.hostkey]},clone(){return U(this.object)},sort(...e){C(this,"sort");let t=this.map(e=>e._id),r=Array.prototype.sort.apply(this,e);delete this._inMethod;let a=this.map(e=>e._id),n=[];t.forEach((e,t)=>{let r=a.indexOf(e);n[t]=r});let s=v();return $(this,s),H(this,void 0,this,this,"sort",{tid:s,keys:[],type:"sort",order:n}),r}};Object.keys(J).forEach(e=>{l(L,e,{value:J[e]})}),["splice","shift","unshfit","push","pop","copyWithin","fill","reverse"].forEach(e=>{let t=Array.prototype[e];t&&l(L,e,{value(...r){C(this,"array-"+e);let a=t.apply(this,r),n=v();return $(this,n),H(this,void 0,this,this,"array-method",{tid:n,keys:[],type:"array-method",methodName:e,args:r}),delete this._inMethod,a}})});const H=(e,t,r,a,n,s)=>{let i={oldVal:a,type:n},l={key:t,val:e[t],type:n,oldVal:a};if(s)void 0!==t&&s.keys.unshift(t);else{let a=[t],i=v();s={tid:i,keys:a,type:n},$(e,i),o(s,{val:{value:r,enumerable:!0}})}i.trend=s,l.trend=s,D(e,"watch-"+t,[e[t],i]),D(e,"watch-",[l]);let{host:h,hostkey:d}=e;h&&H(h,d,e,e,"update",S(s))},I={set(e,t,r,a){if(!/^_.+/.test(t)){let n=e[t],s=e.hasOwnProperty(t)?"update":"new",i=U(r,a,t),l=1;return e._exkeys?e._exkeys.includes(t)?e[t]=i:(l=0,Reflect.set(e,t,i,a)):Reflect.set(e,t,i,a),r instanceof Object&&n instanceof Object&&JSON.stringify(r)==JSON.stringify(n)?l=0:(r===n||e._inMethod)&&(l=0),l&&H(e,t,r,n,s),!0}return Reflect.set(e,t,r,a)},deleteProperty(e,t){if(/^_.+/.test(t))return Reflect.deleteProperty(e,t);{let r=e[t],a=Reflect.deleteProperty(e,t);return!e._inMethod&&H(e,t,void 0,r,"delete"),a}}},U=(e,r,a)=>{switch(u(e)){case"array":case"object":return new t(e,r,a)}return e};O.xdata=(e=>U(e)),O.detrend=R;let q=Object.create(g);q.svRender=!0;for(let e in J)l(q,e,{value:J[e]});l(q,"set",{value(e,t){-1===this._exkeys.indexOf(e)&&this._exkeys.push(e),this[e]=t}});const B=e=>{let a={tag:"",temp:"",attrs:[],props:[],data:{},watch:{}};s(a,e);let{proto:o,props:h,temp:d,tag:c}=a;h.push("value");let u=function(...e){t.apply(this,e)},p=q;if(o){p=i(q);for(let e in o){let{get:t,set:r}=Object.getOwnPropertyDescriptor(o,e);t||r?l(p,e,{set:r,get:t}):p[e]=o[e]}}u.prototype=p;var v=(d=d.replace(/<!--.+?-->/g,"")).match(/{{.+?}}/g);v&&v.forEach(e=>{var t=/{{(.+?)}}/.exec(e);t&&(d=d.replace(e,`<xv-span svkey="${t[1].trim()}"></xv-span>`))}),n[c]=s({},a,{XHear:u,temp:d}),r(a.tag+"[xv-ele]").each((e,t)=>{_(t)})};O.register=B;const F=(e,t)=>{let a=0,n=[],{prevObject:s}=e;return t?e.each((e,r)=>{d(r,"xv-shadow")&&r.getAttribute("xv-shadow")==t&&(n.push(r),a=1)}):e.each((e,t)=>{d(t,"xv-shadow")?a=1:n.push(t)}),a&&(e=r(n),s&&(e.prevObject=s)),e},K=(e,t)=>{let r=e[0].tagName.toLowerCase(),a=n[r],s=new Set([...Object.keys(a.data),...a.props,...a.attrs]);p(s,r=>{e[r]=t[r]})},V=e=>{let t=e.attr("xv-render");t&&(e.find(`[xv-shadow="${t}"]:not([xv-content])`).remove(),e.find(`[xv-shadow="${t}"][xv-content]`).each((e,t)=>{r(t).before(t.childNodes).remove()}));e.find("[xv-render]").each((e,t)=>{V(r(t))})},W=(e,t)=>{let a=u(t);if(e.is("[xv-shadow]")){let n=e.attr("xv-shadow");if("string"==a&&t.search("<")>-1){let e=r(t);e.attr("xv-shadow",n),e.find("*").attr("xv-shadow",n),t="",p(e,e=>{t+=e.outerHTML})}else a instanceof Element?r(t).attr("xv-shadow",n):t instanceof O&&r(Array.from(t)).attr("xv-shadow",n)}return t},X=e=>(e.is("[xv-render]")&&(e=e.map((e,t)=>{let r=t,a=t[f];for(;a&&a.$content;)a=(r=a.$content[0]).xvData;return r})),e);s(g,{add(...t){let r=t[0];if(r instanceof e.$&&r.is("xv-shadow"))throw"shadow element can't use add";return a.add.apply(this,t)},attr(...e){let[t,n]=e;return n&&this.is("[xv-render]")?(this.each((s,i)=>{let l=x(i);l&&l.attrs.indexOf(t)>-1?i[f][t]=n:a.attr.apply(r(i),e)}),this):a.attr.apply(this,e)},clone(...e){if(this.is("[xv-shadow]"))throw"shadow element can't use clone";if(this.svRender){let e=this.html(),t=r(`<div>${e}</div>`);t.find("[xv-render]").each((e,t)=>{r(t).removeAttr("xv-render").attr("xv-ele","")}),e=t.html();this[0].tagName.toLowerCase();let a=this[0].cloneNode();r(a).removeAttr("xv-render").attr("xv-ele","").html(e),_(a);let n=w(a);K(n,this);let s=r("[xv-render]:not([xv-shadow])",this);if(0 in s){let e=r("[xv-render]:not([xv-shadow])",n);e.length==s.length&&e.each((e,t)=>{let r=s[e];if(r.tagName!==t.tagName)return console.warn("cloned xv-ele data does not match"),!1;K(w(t),w(r))})}return n}{let t=this.is("[xv-render]"),n=0 in this.find("[xv-render]");if(t||n){let t=r(Array.from(this)),a=t.clone(...e);V(a),a.find("[xv-render]").removeAttr("xv-render").attr("xv-ele",""),b(a),t.each((e,t)=>{d(t,"xv-render")&&(a[e]=w(t).clone()[0])});let n=e=>{let r=a.find(e);if(0 in r){let a=t.find(e);r.length==a.length&&a.each((e,t)=>{K(w(r[e]),w(t))})}};return n("[xv-render]:not([xv-shadow])"),n("[xv-render][xv-shadow]"),this.prevObject&&(a.prevObject=this),m(a)}a.clone.apply(this,e)}},empty(){return a.empty.call(X(this)),this},parent(e){let t=this.map((e,t)=>{let r=t.parentNode;for(;r.svParent;)r=r.svParent;return r}),r=m(Array.from(new Set(t)));return e&&(r=r.filter(e)),r},parents(e){let t=[];this.each((e,r)=>{let a=r.parentNode;for(;a&&a!==document;){for(;a.svParent;)a=a.svParent;t.push(a),a=a.parentNode}});let r=m(Array.from(new Set(t)));return e&&(r=r.filter(e)),r},parentsUntil(e){let t=[];return this.each((a,n)=>{let s=n.parentNode;for(;s&&s!==document;){for(;s.svParent;)s=s.svParent;if(e&&r(s).is(e))break;t.push(s),s=s.parentNode}}),m(new Set(t))},unwrap(){let e=r(this).parent();return e.is("[xv-content]")?e.each((e,t)=>{let{svParent:a}=t;a=r(a?a:t);let n=t.childNodes;p(n,e=>{a.before(e)}),a.remove()}):a.unwrap.call(this),this},findReal(...e){return m(a.find.apply(this,e))},findShadow(...e){let t=a.find.apply(this,e);return t=F(t,this.attr("xv-render")),m(t)}}),p(["after","before","wrap","wrapAll","replaceWith"],e=>{let t=a[e];t&&(g[e]=function(e){return t.call(this,W(this,e)),b(this.parent()),this})}),p(["insertAfter","insertBefore","replaceAll"],e=>{let t=a[e];t&&(g[e]=function(a){if(this.is("[xv-shadow]"))throw"shadow element can't use "+e;return t.call(W(r(a),this),a),this})}),p(["append","prepend","wrapInner"],e=>{let t=a[e];t&&(g[e]=function(e){return t.call(X(this),W(this,e)),b(this),this})}),p(["appendTo","prependTo"],e=>{let t=a[e];t&&(g[e]=function(a){if(this.is("[xv-shadow]"))throw"shadow element can't use "+e;let n=r(a);return n.is("[xv-shadow]")&&W(n,this),t.call(this,X(n)),this})}),p(["find","children"],e=>{let t=a[e];t&&(g[e]=function(e){let r=t.call(X(this),e);return 1==r.length&&r[0][f]?r=w(r[0]):(r=this.is("[xv-shadow]")?F(r,this.attr("xv-shadow")):F(r),r=m(r)),r})}),p(["eq","first","last","filter","has","not","slice","next","nextAll","nextUntil","prev","prevAll","prevUntil","siblings"],e=>{a[e]&&(g[e]=function(...t){let r=a[e].apply(this,t);return r=m(r)})}),p(["html","text"],e=>{let t=a[e];t&&(g[e]=function(a){let n=this;if((e=>void 0===e)(a)){let e=r(n[0]);if(0 in e.find("[xv-shadow]")){let a=r(e[0].cloneNode(!0));return V(a),t.call(a)}return t.call(e)}return"text"!==e&&(a=W(this,a)),n=t.call(X(this),a),b(this),n})}),(()=>{let{pushStack:e}=a;e&&(g.pushStack=function(...t){return m(e.apply(this,t))})})();const G={register:B};e.xhear=G,e.$=O,r(()=>{const e=e=>{if(e[y])return;let t=x(e);t.attached&&t.attached.call(e,w(e)),e[y]=1},t=e=>{if(e.getRootNode()!=document){let t=x(e);t.detached&&t.detached.call(e,w(e)),r("[xv-content]",e).each((e,t)=>{delete t.svParent});let a=e[f];a&&(a.__obs&&a.__obs.disconnect(),delete a.__obs,delete e[f])}};new MutationObserver(a=>{a.forEach(a=>{let{addedNodes:n,removedNodes:s}=a;n&&0 in n&&p(n,t=>{t[f]&&e(t),t instanceof Element&&p(t.querySelectorAll("[xv-render]"),t=>{e(t)})}),s&&0 in s&&p(s,e=>{e[f]&&t(e),r("[xv-render]",e).each((e,r)=>{t(r)})})})}).observe(document.body,{attributes:!1,childList:!0,characterData:!1,subtree:!0}),r("[xv-ele]").each((e,t)=>{_(t)})}),r("head").append("<style>[xv-ele]{display:none}</style>")})(window);