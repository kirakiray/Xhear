(e=>{"use strict";function t(e,t,r){h(this,{_id:{value:v()},_obs:{value:[]},_trend:{value:[]},_syncs:{value:[]},_watch:{value:{}},_canEmitWatch:{writable:!0,value:0},isRoot:{value:!!e}}),e?(o(this,"_root",{value:e}),o(this,"_host",{value:{target:t,key:r}})):o(this,"_cache",{value:{}})}function r(...e){t.apply(this,e)}let a=e.$,n=a.fn,s={};e.tagDatabase=s;const{assign:i,create:l,defineProperty:o,defineProperties:h}=Object;let c=e=>void 0!==e&&null!==e;const d=(e,t)=>{if(!e.getAttribute)return!1;let r=e.getAttribute(t);return null!==r&&void 0!==r||void 0};let u=Object.prototype.toString;const p=e=>u.call(e).toLowerCase().replace(/(\[object )|(])/g,""),f=(e,t)=>Array.from(e).forEach(t),v=()=>Math.random().toString(32).substr(2),y=((()=>{let e=!1,t=[]})(),v(),v()+"_xhearobj"),x=v()+"_attached",w=e=>{let t=e.tagName.toLowerCase();return s[t]},b=e=>{let t=e[y],r=l(t);return r.push(e),r},m=e=>1==e.length&&e[0][y]?b(e[0]):(e=>{let t=l(_);return t.splice(-1,0,...e),e.prevObject&&(t.prevObject=e.prevObject),t})(e),g=e=>{e.is("[xv-ele]")&&e.each((e,t)=>{O(t)}),a("[xv-ele]",Array.from(e)).each((e,t)=>{O(t)})};let _=l(n),k=100;const O=e=>{if(!d(e,"xv-ele"))return;let t=w(e);if(!t)return void console.warn("no exist tag",e);let r=a(e),n=Array.from(e.childNodes);e.innerHTML=t.temp;let s=++k,l=new t.XHear;l._canEmitWatch=1;let h=new Proxy(l,P);e[y]=h;let u=b(e);r.removeAttr("xv-ele").attr("xv-render",s),r.find("*").attr("xv-shadow",s),a(`[xv-ele][xv-shadow="${s}"]`,e).each((e,t)=>{O(t)}),a(`xv-span[xv-shadow="${s}"]`,e).each((e,t)=>{var r=document.createTextNode("");t.parentNode.insertBefore(r,t),t.parentNode.removeChild(t);var a=t.getAttribute("svkey");h.watch(a,e=>{r.textContent=e})});let f=a(`[xv-content][xv-shadow="${s}"]`,e);if(0 in f&&(o(h,"$content",{enumerable:!0,get:()=>m(f)}),f.prop("svParent",e),f.append(n),t.childChange)){let r=new MutationObserver(r=>{r.forEach(r=>{let{addedNodes:a,removedNodes:n}=r,s={};0 in a&&(s.addedNodes=Array.from(a)),0 in n&&(s.removedNodes=Array.from(n)),t.childChange(b(e),s)})});r.observe(f[0],{attributes:!1,childList:!0,characterData:!1,subtree:!1}),h.__obs=r}a(`[xv-tar][xv-shadow="${s}"]`,e).each((e,t)=>{let r=a(t).attr("xv-tar");o(h,"$"+r,{enumerable:!0,get:()=>m([t])})});let v=i({},t.data);t.attrs.forEach(e=>{let t=r.attr(e);c(t)&&(v[e]=t),h.watch(e,t=>{r.attr(e,t)})}),t.props.forEach(e=>{let t=r.attr(e);c(t)&&(v[e]=t)}),a(`[xv-module][xv-shadow="${s}"]`,e).each((e,t)=>{let r=a(t),n=r.attr("xv-module");h.watch(n,e=>{t.value=e}),t[y]?t[y].watch("value",e=>{h[n]=e}):r.on("change input",e=>{h[n]=t.value})}),r.removeAttr("xv-ele").attr("xv-render",s);let g=t.watch;if(g)for(let e in g)e in v||(v[e]=void 0);if(l._exkeys=Object.keys(v),g)for(let e in g){let t,r,a=g[e];switch(p(a)){case"function":r=a;break;case"object":t=a.get,r=a.set}t&&watchGetter(h,e,t.bind(u)),r&&h.watch(e,r.bind(u))}"value"in v&&o(e,"value",{get:()=>h.value,set(e){h.value=e}});for(let e in v)c(v[e])&&(h[e]=v[e]);t.inited&&t.inited.call(e,u),t.attached&&e.getRootNode()===document&&!e[x]&&(t.attached.call(e,u),e[x]=1)};let j=function(...e){let t=a(...e),[r,n]=e;("string"==p(r)&&r.search("<")>-1||r instanceof Element)&&g(t);let s;return n&&(n.getAttribute?s=n.getAttribute("xv-shadow"):n.attr&&(s=n.attr("xv-shadow"))),t=s?L(t,s):L(t),t=m(t)};j.prototype=n,i(j,{init:(...e)=>m(e)},a);let A=e=>e instanceof t||e instanceof r,N=e=>{let t=e;if(e instanceof Array)t=[],e.forEach(e=>{A(e)?t.push(N(e)):t.push(e)});else if(e instanceof Object){t={};for(let r in e){let a=e[r];A(a)?t[r]=N(a):t[r]=a}}return t};let E=(e,t,r,a,n="update",s)=>{if(!e._canEmitWatch)return;if("uphost"!==n&&r===a)return;if("update"==n&&A(r)&&A(a)&&r.stringify()===a.stringify())return;let l=e._watch[t];l&&l.forEach(e=>{let t={oldVal:a,type:n};"uphost"==n?t.uphost=i({},s):"uparray"==n&&(t.uparray=i({},s),delete t.oldVal),e(r,t)}),e._obs.forEach(l=>{let o={target:e,type:n,key:t,val:r,oldVal:a};"uphost"==n?o.uphost=i({},s):"uparray"==n&&(o.uparray=i({},s),delete o.oldVal),l(o)});let{_host:o}=e;if("uphost"!==n){let{_trend:l,_host:o}=e,h=[],c=t;for(;l;){h.unshift(c);let e={key:h,val:N(r),oldVal:N(a),type:n};if("uparray"==n&&(e.uparray=s),l.forEach(t=>{t(i({},e))}),o){let t=o.target[o.key];E(o.target,o.key,t,t,"uphost",e),l=o.target._trend,c=o.key,o=o.target._host}else l=null}}},P={set(e,t,r,a){if(/^_.+/.test(t))return Reflect.set(e,t,r,a);{let n=e[t],s=e.hasOwnProperty(t)?"update":"new";A(r)&&(r=r.toObject()),r=S(r,e._root||e,e,t);let i=!0;return e._exkeys?e._exkeys.indexOf(t)>-1?(e[t]=r,E(e,t,r,n,s)):i=Reflect.set(e,t,r,a):(i=Reflect.set(e,t,r,a),E(e,t,r,n,s)),i}},deleteProperty(e,t){if(/^_.+/.test(t))return Reflect.deleteProperty(e,t);{let r=e[t],a=Reflect.deleteProperty(e,t);return E(e,t,void 0,r,"delete"),a}}};let $={watch(e,t){switch(p(e)){case"string":let r=this._watch[e]||(this._watch[e]=[]);t&&r.push(t);break;case"object":for(let t in e)this.watch(t,e[t])}return this},unwatch(e,t){switch(p(e)){case"string":let r=this._watch[e]||(this._watch[e]=[]),a=r.indexOf(t);a>-1&&r.splice(a,1);break;case"object":for(let t in e)this.watch(t,e[t])}return this},observe(e){return e&&this._obs.push(e),this},unobserve(e){let t=this._obs.indexOf(e);return t>-1&&this._obs.splice(t,1),this},reset(e,t){if(t){if(t.watch)for(let e in this._watch)delete this._watch[e];t.obs&&(this._obs.length=0),t.trend&&(this._trend.length=0),sync&&(this._syncs.length=0)}for(let e in this)delete this[e];i(this,e)},trend(e){return e&&this._trend.push(e),this},entrend(e){let[t,r]=((e,t)=>{let r,a,n=t.key.length-1;return t.key.forEach((t,s)=>{e instanceof Object&&s<=n&&(s==n&&(r=e,a=t),e=e[t])}),[r,a]})(this,e);switch(e.type){case"delete":delete t[r];break;case"uparray":let{args:a,fname:n}=e.uparray,s=t[e.key.slice(-1)[0]];if(s[n]){this._canEmitWatch=0,s[n](...a),this._canEmitWatch=1;break}default:t[r]=e.val}return this},untrend(e){let t=this._trend.indexOf(e);return t>-1&&this._trend.splice(t,1),this},sync(e,t){return e.reset(this.toObject()),((e,t,r)=>{let a,n,s=p(r);switch(s){case"string":a=(e=>{let a=e.key[0];r===a&&t.entrend(e)}),n=(t=>{let a=t.key[0];r===a&&e.entrend(t)});break;case"array":a=(e=>{let a=e.key[0];r.indexOf(a)>-1&&t.entrend(e)}),n=(t=>{let a=t.key[0];r.indexOf(a)>-1&&e.entrend(t)});break;case"object":let i=Object.keys(r),l=Object.values(r);a=(e=>{let r=e.key[0];i.indexOf(r)>-1&&((e=Object.assign({},e)).key[0]=l[i.indexOf(r)],t.entrend(e))}),n=(t=>{let r=t.key[0];l.indexOf(r)>-1&&((t=Object.assign({},t)).key[0]=i[l.indexOf(r)],e.entrend(t))});break;default:a=(e=>t.entrend(e)),n=(t=>e.entrend(t))}e.trend(a),t.trend(n);let i=v();e._syncs.push({bid:i,type:s,func:a,opp:t}),t._syncs.push({bid:i,type:s,func:n,opp:e})})(this,e,t),this},unsync(e,t){return((e,t,r)=>{let a=p(r),n=e._syncs.find(e=>e.opp===t&&e.type===a);if(n){let{bid:r}=n,a=e._syncs.find(e=>e.bid==r),s=t._syncs.find(e=>e.bid==r);e._syncs.splice(a,1);let i=t._syncs.splice(s,1);i=i[0],e.untrend(n.func),t.untrend(i.func)}})(this,e,t),this},transData(e){let t={key:"",target:"",targetKey:""};i(t,e);let{key:r,target:a,targetKey:n,trans:s}=t;if(t.trans){let e={};for(let t in s)e[s[t]]=t;this.watch(r,e=>{e=s[e],a[n]=e}),a.watch(n,t=>{t=e[t],this[r]=t})}},toObject(){return N(this)},stringify(){let e=N(this);return JSON.stringify(e)}};for(let e in $)o(t.prototype,e,{value:$[e]});let R=Object.create(Array.prototype);for(let e in $)o(R,e,{value:$[e]});["splice","push","unshift","pop","shift","sort","reverse","fill"].forEach(e=>{let t=R[e];t&&o(R,e,{value(...r){let a=v();this._canEmitWatch=0;let n=t.apply(this,r);this._canEmitWatch=1;let s=h({},{fname:{enumerable:!0,value:e},tid:{enumerable:!0,value:a},args:{enumerable:!0,value:r}}),{_host:i}=this;return E(i.target,i.key,this,"","uparray",s),n}})}),r.prototype=R;let S=(e,a,n,s)=>{switch(p(e)){case"object":return((e,r,a,n)=>{let s=new t(r,a,n),l=new Proxy(s,P);return i(l,e),s._canEmitWatch=1,l})(e,a,n,s);case"array":return((e,t,a,n)=>{let s=new r(t,a,n),i=new Proxy(s,P);return Array.prototype.splice.call(i,0,0,...e),s._canEmitWatch=1,i})(e,a,n,s)}return e};j.xdata=(e=>S(e));let W=Object.create(_);W.svRender=!0;for(let e in $)o(W,e,{value:$[e]});o(W,"set",{value(e,t){-1===this._exkeys.indexOf(e)&&this._exkeys.push(e),this[e]=t}});const C=e=>{let r={tag:"",temp:"",attrs:[],props:[],data:{},watch:{}};i(r,e);let{proto:n,props:o,temp:h,tag:c}=r;o.push("value");let d=function(...e){t.apply(this,e)},u=W;n&&(u=l(W),i(u,n)),d.prototype=u;var p=(h=h.replace(/<!--.+?-->/g,"")).match(/{{.+?}}/g);p&&p.forEach(e=>{var t=/{{(.+?)}}/.exec(e);t&&(h=h.replace(e,`<xv-span svkey="${t[1].trim()}"></xv-span>`))}),s[c]=i({},r,{XHear:d,temp:h}),a(r.tag+"[xv-ele]").each((e,t)=>{O(t)})};j.register=C;const L=(e,t)=>{let r=0,n=[],{prevObject:s}=e;return t?e.each((e,a)=>{d(a,"xv-shadow")&&a.getAttribute("xv-shadow")==t&&(n.push(a),r=1)}):e.each((e,t)=>{d(t,"xv-shadow")?r=1:n.push(t)}),r&&(e=a(n),s&&(e.prevObject=s)),e},D=(e,t)=>{let r=e[0].tagName.toLowerCase(),a=s[r],n=new Set([...Object.keys(a.data),...a.props,...a.attrs]);f(n,r=>{e[r]=t[r]})},M=e=>{let t=e.attr("xv-render");t&&(e.find(`[xv-shadow="${t}"]:not([xv-content])`).remove(),e.find(`[xv-shadow="${t}"][xv-content]`).each((e,t)=>{a(t).before(t.childNodes).remove()}));e.find("[xv-render]").each((e,t)=>{M(a(t))})},T=(e,t)=>{let r=p(t);if(e.is("[xv-shadow]")){let n=e.attr("xv-shadow");if("string"==r&&t.search("<")>-1){let e=a(t);e.attr("xv-shadow",n),e.find("*").attr("xv-shadow",n),t="",f(e,e=>{t+=e.outerHTML})}else r instanceof Element?a(t).attr("xv-shadow",n):t instanceof j&&a(Array.from(t)).attr("xv-shadow",n)}return t},V=e=>(e.is("[xv-render]")&&(e=e.map((e,t)=>{let r=t,a=t[y];for(;a&&a.$content;)a=(r=a.$content[0]).xvData;return r})),e);i(_,{add(...t){let r=t[0];if(r instanceof e.$&&r.is("xv-shadow"))throw"shadow element can't use add";return n.add.apply(this,t)},attr(...e){let[t,r]=e;if(!r||!this.is("[xv-render]"))return n.attr.apply(this,e);this.each((s,i)=>{let l=w(i);l&&l.attrs.indexOf(t)>-1?i[y][t]=r:n.attr.apply(a(i),e)})},clone(...e){if(this.is("[xv-shadow]"))throw"shadow element can't use clone";if(this.svRender){let e=this.html(),t=a(`<div>${e}</div>`);t.find("[xv-render]").each((e,t)=>{a(t).removeAttr("xv-render").attr("xv-ele","")}),e=t.html();this[0].tagName.toLowerCase();let r=this[0].cloneNode();a(r).removeAttr("xv-render").attr("xv-ele","").html(e),O(r);let n=b(r);D(n,this);let s=a("[xv-render]:not([xv-shadow])",this);if(0 in s){let e=a("[xv-render]:not([xv-shadow])",n);e.length==s.length&&e.each((e,t)=>{let r=s[e];if(r.tagName!==t.tagName)return console.warn("cloned xv-ele data does not match"),!1;D(b(t),b(r))})}return n}{let t=this.is("[xv-render]"),r=0 in this.find("[xv-render]");if(t||r){let t=a(Array.from(this)),r=t.clone(...e);M(r),r.find("[xv-render]").removeAttr("xv-render").attr("xv-ele",""),g(r),t.each((e,t)=>{d(t,"xv-render")&&(r[e]=b(t).clone()[0])});let n=e=>{let a=r.find(e);if(0 in a){let r=t.find(e);a.length==r.length&&r.each((e,t)=>{D(b(a[e]),b(t))})}};return n("[xv-render]:not([xv-shadow])"),n("[xv-render][xv-shadow]"),this.prevObject&&(r.prevObject=this),m(r)}n.clone.apply(this,e)}},empty(){return n.empty.call(V(this)),this},parent(e){let t=this.map((e,t)=>{let r=t.parentNode;for(;r.svParent;)r=r.svParent;return r}),r=m(Array.from(new Set(t)));return e&&(r=r.filter(e)),r},parents(e){let t=[];this.each((e,r)=>{let a=r.parentNode;for(;a&&a!==document;){for(;a.svParent;)a=a.svParent;t.push(a),a=a.parentNode}});let r=m(Array.from(new Set(t)));return e&&(r=r.filter(e)),r},parentsUntil(e){let t=[];return this.each((r,n)=>{let s=n.parentNode;for(;s&&s!==document;){for(;s.svParent;)s=s.svParent;if(e&&a(s).is(e))break;t.push(s),s=s.parentNode}}),m(new Set(t))},unwrap(){let e=a(this).parent();return e.is("[xv-content]")?e.each((e,t)=>{let{svParent:r}=t;r=a(r?r:t);let n=t.childNodes;f(n,e=>{r.before(e)}),r.remove()}):n.unwrap.call(this),this},findReal(...e){return m(n.find.apply(this,e))},findShadow(...e){let t=n.find.apply(this,e);return t=L(t,this.attr("xv-render")),m(t)}}),f(["after","before","wrap","wrapAll","replaceWith"],e=>{let t=n[e];t&&(_[e]=function(e){return t.call(this,T(this,e)),g(this.parent()),this})}),f(["insertAfter","insertBefore","replaceAll"],e=>{let t=n[e];t&&(_[e]=function(r){if(this.is("[xv-shadow]"))throw"shadow element can't use "+e;return t.call(T(a(r),this),r),this})}),f(["append","prepend","wrapInner"],e=>{let t=n[e];t&&(_[e]=function(e){return t.call(V(this),T(this,e)),g(this),this})}),f(["appendTo","prependTo"],e=>{let t=n[e];t&&(_[e]=function(r){if(this.is("[xv-shadow]"))throw"shadow element can't use "+e;let n=a(r);return n.is("[xv-shadow]")&&T(n,this),t.call(this,V(n)),this})}),f(["find","children"],e=>{let t=n[e];t&&(_[e]=function(e){let r=t.call(V(this),e);return 1==r.length&&r[0][y]?r=b(r[0]):(r=this.is("[xv-shadow]")?L(r,this.attr("xv-shadow")):L(r),r=m(r)),r})}),f(["eq","first","last","filter","has","not","slice","next","nextAll","nextUntil","prev","prevAll","prevUntil","siblings"],e=>{n[e]&&(_[e]=function(...t){let r=n[e].apply(this,t);return r=m(r)})}),f(["html","text"],e=>{let t=n[e];t&&(_[e]=function(r){let n=this;if((e=>void 0===e)(r)){let e=a(n[0]);if(0 in e.find("[xv-shadow]")){let r=a(e[0].cloneNode(!0));return M(r),t.call(r)}return t.call(e)}return"text"!==e&&(r=T(this,r)),n=t.call(V(this),r),g(this),n})}),(()=>{let{pushStack:e}=n;e&&(_.pushStack=function(...t){return m(e.apply(this,t))})})();const H={register:C};e.xhear=H,e.$=j,a(()=>{const e=e=>{if(e[x])return;let t=w(e);t.attached&&t.attached.call(e,b(e)),e[x]=1},t=e=>{if(e.getRootNode()!=document){let t=w(e);t.detached&&t.detached.call(e,b(e)),a("[xv-content]",e).each((e,t)=>{delete t.svParent});let r=e[y];r&&(r.__obs&&r.__obs.disconnect(),delete r.__obs,delete e[y])}};new MutationObserver(r=>{r.forEach(r=>{let{addedNodes:n,removedNodes:s}=r;n&&0 in n&&f(n,t=>{t[y]&&e(t),t instanceof Element&&f(t.querySelectorAll("[xv-render]"),t=>{e(t)})}),s&&0 in s&&f(s,e=>{e[y]&&t(e),a("[xv-render]",e).each((e,r)=>{t(r)})})})}).observe(document.body,{attributes:!1,childList:!0,characterData:!1,subtree:!0}),a("[xv-ele]").each((e,t)=>{O(t)})}),a("head").append("<style>[xv-ele]{display:none}</style>")})(window);