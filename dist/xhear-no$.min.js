(e=>{"use strict";function t(e,t,r){h(this,{_id:{value:e._id||f()},[A]:{value:e[A]||{}},[E]:{value:e[E]||[]},[$]:{value:e[$]||[]},[P]:{value:e[P]||[]},_trendClear:{writable:!0,value:0}}),e._id||l(e,"_id",{value:this._id}),t&&h(this,{root:{value:t.root||t},host:{value:t},hostkey:{value:r}});let a=Object.keys(e);"array"===u(e)&&a.push("length");let s=new Proxy(this,U);return a.forEach(t=>{let{get:r,set:a,value:n}=Object.getOwnPropertyDescriptor(e,t);r||a?l(this,t,{get:r,set:a}):this[t]=B(n,s,t)}),s}let r=e.$,a=r.fn,s={};e.tagDatabase=s;const{assign:n,create:i,defineProperty:l,defineProperties:h}=Object;let o=e=>void 0!==e&&null!==e;const d=(e,t)=>{if(!e.getAttribute)return!1;let r=e.getAttribute(t);return null!==r&&void 0!==r||void 0};let c=Object.prototype.toString;const u=e=>c.call(e).toLowerCase().replace(/(\[object )|(])/g,""),p=(e,t)=>Array.from(e).forEach(t),f=()=>Math.random().toString(32).substr(2),v=((()=>{let e=!1,t=[]})(),f(),f()+"_xhearobj"),y=f()+"_attached",x=e=>{let t=e.tagName.toLowerCase();return s[t]},w=e=>{let t=e[v],r=i(t);return r.push(e),r},m=e=>1==e.length&&e[0][v]?w(e[0]):(e=>{let t=i(g);return t.splice(-1,0,...e),e.prevObject&&(t.prevObject=e.prevObject),t})(e),b=e=>{e.is("[xv-ele]")&&e.each((e,t)=>{N(t)}),r("[xv-ele]",Array.from(e)).each((e,t)=>{N(t)})};let g=i(a),k=100;const _=(e,t)=>{let{tag:r}=e,a={};Object.keys(e).forEach(t=>{/\D/.test(t)&&(a[t]=e[t])}),delete a.tag,delete a.length;let s=j(`<${r} xv-ele xv-rid="${e._id}"></${r}>`);n(s,a),t(s),Array.from(e).forEach(e=>{_(e,e=>{s.append(e)})})},O=(e,t)=>{e.hide(),e.empty(),t.forEach(t=>{_(t,t=>{e.append(t)})}),e.show()},N=e=>{if(!d(e,"xv-ele"))return;let t=x(e);if(!t)return void console.warn("no exist tag",e);let a=r(e),s=Array.from(e.childNodes);e.innerHTML=t.temp;let i=++k,h=new t.XHear({}),c=new Proxy(h,U);e[v]=c;let p=w(e);a.removeAttr("xv-ele").attr("xv-render",i),a.find("*").attr("xv-shadow",i),r(`[xv-ele][xv-shadow="${i}"]`,e).each((e,t)=>{N(t)}),r(`xv-span[xv-shadow="${i}"]`,e).each((e,t)=>{var r=document.createTextNode("");t.parentNode.insertBefore(r,t),t.parentNode.removeChild(t);var a=t.getAttribute("svkey");c.watch(a,e=>{r.textContent=e})});let f=r(`[xv-content][xv-shadow="${i}"]`,e);if(0 in f&&(l(c,"$content",{enumerable:!0,get:()=>m(f)}),f.prop("svParent",e),f.append(s),t.childChange)){let r=new MutationObserver(r=>{r.forEach(r=>{let{addedNodes:a,removedNodes:s}=r,n={};0 in a&&(n.addedNodes=Array.from(a)),0 in s&&(n.removedNodes=Array.from(s)),t.childChange(w(e),n)})});r.observe(f[0],{attributes:!1,childList:!0,characterData:!1,subtree:!1}),c.__obs=r}r(`[xv-tar][xv-shadow="${i}"]`,e).each((e,t)=>{let a=r(t).attr("xv-tar");l(c,"$"+a,{enumerable:!0,get:()=>m([t])})});let b=n({},t.data);t.attrs.forEach(e=>{let t=a.attr(e);o(t)&&(b[e]=t),c.watch(e,t=>{a.attr(e,t)})}),t.props.forEach(e=>{let t=a.attr(e);o(t)&&(b[e]=t)}),r(`[xv-module][xv-shadow="${i}"]`,e).each((e,t)=>{let a=r(t),s=a.attr("xv-module");c.watch(s,e=>{t.value=e}),t[v]?t[v].watch("value",e=>{c[s]=e}):a.on("change input",e=>{c[s]=t.value})}),a.removeAttr("xv-ele").attr("xv-render",i);let g=t.watch;if(g)for(let e in g)e in b||(b[e]=void 0);p.watch("render",(e,t)=>{if("new"===t.type)return void O(p,e);let{trend:r}=t,[a,s]=j.detrend(p,r),n=a[s];if("array-method"==r.type){switch(r.methodName){case"copyWithin":case"fill":case"reverse":case"sort":return void O(p,e)}let t,a,s,i=p.find(`[xv-rid="${n._id}"]`);switch(r.methodName){case"splice":[t,a,...s]=r.args;break;case"shift":t=0,a=1,s=[];break;case"unshfit":t=0,a=0,s=r.args;break;case"push":t=i.children().length,a=0,s=r.args;break;case"pop":t=i.children().length,a=1,s=[]}let l=t+a;a>0&&i.children().each((e,r)=>{e>=t&&e<l&&j(r).remove()});let h=i.children().eq(t);s.forEach(e=>{_(e,e=>{0 in h?h.before(e):i.append(e)})})}else if(/\D/.test(s)){p.find(`[xv-rid="${a._id}"]`)[s]=n}else{let{oldId:e}=r;if(e){let t=p.find(`[xv-rid="${e}"]`);_(n,e=>{t.after(e)}),t.remove()}}});let A=Object.keys(b);if(A.includes("value")||A.push("value"),A.includes("render")||A.push("render"),h._exkeys=A,g)for(let e in g){let t,r,a=g[e];switch(u(a)){case"function":r=a;break;case"object":t=a.get,r=a.set}t&&watchGetter(c,e,t.bind(p)),r&&c.watch(e,r.bind(p))}l(e,"value",{get:()=>c.value,set(e){c.value=e}});for(let e in b)o(b[e])&&(c[e]=b[e]);t.inited&&t.inited.call(e,p),t.attached&&e.getRootNode()===document&&!e[y]&&(t.attached.call(e,p),e[y]=1)};let j=function(...e){let t=r(...e),[a,s]=e;("string"==u(a)&&a.search("<")>-1||a instanceof Element)&&b(t);let n;return s&&(s.getAttribute?n=s.getAttribute("xv-shadow"):s.attr&&(n=s.attr("xv-shadow"))),t=n?V(t,n):V(t),t=m(t)};j.prototype=a,n(j,{init:(...e)=>m(e)},r);const A="_events_"+f(),E="_syncs_"+f(),$="_trend_"+f(),P="_listen_"+f();let S,C=e=>e instanceof Object?JSON.parse(JSON.stringify(e)):e;(()=>{let e=[],t=0;S=(r=>{e.push(r),t||setTimeout(()=>{t=0;let r=e;e=[],r.forEach(e=>e())},5e3),t=1})})();const D=(e,t)=>{e[$].push(t),e._trendClear||(e._trendClear=1,S(()=>{e[$].length=0,e._trendClear=0}))},M=(e,t)=>l(e,"_inMethod",{configurable:!0,value:t}),R=(e,r,a)=>{let s=[];void 0===a?e.hasOwnProperty(r)&&s.push(e):e[r]==a&&s.push(e);for(let n in e){let i=e[n];if(i instanceof t){R(i,r,a).forEach(e=>{s.includes(e)||s.push(e)})}}return s},T=(e,t)=>{let r,a=t.keys.length-1;return t.keys.forEach((t,s)=>{s<a&&(e=e[t]),r=t}),[e,r]},L=(e,t)=>e[A][t]||(e[A][t]=[]),J=(e,t,r)=>{L(e,t).forEach(e=>{e(...r)})};let W=Object.create(Array.prototype);h(W,{string:{get(){return JSON.stringify(this)}},object:{get(){return C(this)}}}),t.prototype=W;let I={watch(e,t){let r=u(e);if("object"===r){for(let t in e)this.watch(t,e[t]);return this}return r.search("function")>-1&&(t=e,e=""),((e,t,r)=>L(e,t).push(r))(this,"watch-"+e,t),this},unwatch(e,t){let r=u(e);if("object"===r){for(let t in e)this.unwatch(t,e[t]);return this}return r.search("function")>-1&&(t=e,e=""),((e,t,r)=>{let a=L(e,t),s=a.indexOf(r);a.splice(s,1)})(this,"watch-"+e,t),this},reset(e){let t=Object.keys(e);return Object.keys(this).forEach(e=>{t.includes(e)||delete this[e]}),n(this,e),this},entrend(e){if(!e.tid)throw"trendData invalid";if(this[$].includes(e.tid))return;D(this,e.tid);let[t,r]=T(this,e),a=t.slice();switch(e.type){case"sort":M(this,"sort"),e.order.forEach((e,r)=>{t[e]=a[r]});break;case"delete":M(this,"delete"),delete t[r];break;case"array-method":let{methodName:s,args:n}=e;M(this,"array-"+s),"copyWithin"===s?H.apply(t,n):Array.prototype[s].apply(t,n);break;default:M(this,"default"),t[r]=C(e.val)}return delete this._inMethod,this[E].forEach(t=>{t.func({trend:e})}),this},sync(e,t){let r,a;switch(u(t)){case"object":let s={};for(let e in t)s[t[e]]=e;r=(e=>{let t=C(e.trend),r=s[e.key];void 0!==r&&(t.keys[0]=r,this.entrend(t))}),a=(r=>{let a=C(r.trend),s=t[r.key];void 0!==s&&(a.keys[0]=s,e.entrend(a))});break;case"array":r=(e=>{t.includes(e.key)&&this.entrend(e.trend)}),a=(r=>{t.includes(r.key)&&e.entrend(r.trend)});break;case"string":r=(e=>{e.key===t&&this.entrend(e.trend)}),a=(r=>{r.key===t&&e.entrend(r.trend)});break;default:r=(e=>this.entrend(e.trend)),a=(t=>e.entrend(t.trend))}e.watch(r),this.watch(a);let s=f();return e[E].push({bid:s,options:t,opp:this,func:r}),this[E].push({bid:s,options:t,opp:e,func:a}),this},unsync(e,t){let r=this[E].findIndex(r=>r.opp===e&&r.options===t);if(r>-1){let t=this[E][r],a=e[E].findIndex(e=>e.bid===t.bid),s=e[E][a];this.unwatch(t.func),e.unwatch(s.func),this[E].splice(r,1),e[E].splice(a,1)}else console.log("not found =>",e);return this},seek(e){let t,r=e.match(/\[.+?\]/g);return r?r.forEach((e,r)=>{let[a,s]=e.replace(/[\[]|[\]]/g,"").split("="),n=R(this,a,s);if(0===r)t=n;else{let e=[];n.forEach(r=>{t.includes(r)&&e.push(r)}),t=e}}):t=R(this,"_id",e)[0],t},listen(e,t,r=10){let a;if(e){let s,n=JSON.stringify(this.seek(e).map(e=>e._id));this.watch(a=(a=>{let i=this.seek(e),l=i.map(e=>e._id);JSON.stringify(l)!==n&&(clearTimeout(s),s=setTimeout(()=>{t(i)},r))}))}else{let e;this.watch(a=(a=>{clearTimeout(e),e=setTimeout(()=>{t(tempData)},r)}))}return this[P].push({expr:e,callback:t,watchFunc:a}),this},unlisten(e,t){return this[P].forEach(r=>{if(r.expr===e&&r.callback===t){let{watchFunc:e}=r;this.unwatch(e)}}),this},transData(e){let t={key:"",target:"",targetKey:""};n(t,e);let{key:r,target:a,targetKey:s,trans:i}=t;if(t.trans){let e={};for(let t in i)e[i[t]]=t;this.watch(r,e=>{e=i[e],a[s]=e}),a.watch(s,t=>{t=e[t],this[r]=t})}},clear(...e){let[t]=e;0 in e?"number"===u(t)?this.splice(t,1):delete this[t]:this.host&&delete this.host[this.hostkey]},clone(){return B(this.object)},sort(...e){M(this,"sort");let t=this.map(e=>e._id),r=Array.prototype.sort.apply(this,e);delete this._inMethod;let a=this.map(e=>e._id),s=[];t.forEach((e,t)=>{let r=a.indexOf(e);s[t]=r});let n=f();return D(this,n),q(this,void 0,this,this,"sort",{tid:n,keys:[],type:"sort",order:s}),r}};Object.keys(I).forEach(e=>{l(W,e,{value:I[e]})});let H=function(e,r,a){let s=this.slice(r,a),n=s.some(e=>e instanceof t),i=this.length-1;if(n){let r=0;return this.forEach((a,n)=>{if(n>=e&&n<i){let e=s[r];e instanceof t&&(e=B(e.object,this,n)),this[n]=e,r++}}),this}return Array.prototype.copyWithin.call(this,e,r,a)};l(W,"copyWithin",{writable:!0,value(...e){return H.apply(this,e)}}),["splice","shift","unshfit","push","pop","fill",,"reverse","copyWithin"].forEach(e=>{let t=W[e];t&&l(W,e,{value(...r){M(this,"array-"+e);let a=t.apply(this,r),s=f();return D(this,s),q(this,void 0,this,this,"array-method",{tid:s,keys:[],type:"array-method",methodName:e,args:r}),delete this._inMethod,a}})});const q=(e,r,a,s,n,i)=>{let l={oldVal:s,type:n},o={key:r,val:e[r],type:n,oldVal:s};if(i)void 0!==r&&i.keys.unshift(r);else{let l=[r],o=f();i={tid:o,keys:l,type:n},s instanceof t&&(i.oldId=s._id),D(e,o),h(i,{val:{value:a,enumerable:!0}})}l.trend=i,o.trend=i,J(e,"watch-"+r,[e[r],l]),J(e,"watch-",[o]);let{host:d,hostkey:c}=e;d&&q(d,c,e,e,"update",C(i))},U={set(e,t,r,a){if(!/^_.+/.test(t)){let s=e[t],n=e.hasOwnProperty(t)?"update":"new",i=B(r,a,t),l=1;return e._exkeys?e._exkeys.includes(t)?e[t]=i:(l=0,Reflect.set(e,t,i,a)):Reflect.set(e,t,i,a),r instanceof Object&&s instanceof Object&&JSON.stringify(r)==JSON.stringify(s)?l=0:(r===s||e._inMethod)&&(l=0),l&&q(e,t,r,s,n),!0}return Reflect.set(e,t,r,a)},deleteProperty(e,t){if(/^_.+/.test(t))return Reflect.deleteProperty(e,t);{let r=e[t],a=Reflect.deleteProperty(e,t);return!e._inMethod&&q(e,t,void 0,r,"delete"),a}}},B=(e,r,a)=>{switch(u(e)){case"array":case"object":return new t(e,r,a)}return e};j.xdata=(e=>B(e)),j.detrend=T;let F=Object.create(g);F.svRender=!0;for(let e in I)l(F,e,{value:I[e]});l(F,"set",{value(e,t){-1===this._exkeys.indexOf(e)&&this._exkeys.push(e),this[e]=t}});const K=e=>{let a={tag:"",temp:"",attrs:[],props:[],data:{},watch:{}};n(a,e);let{proto:h,props:o,temp:d,tag:c}=a;o.push("value");let u=function(...e){t.apply(this,e)},p=F;if(h){p=i(F);for(let e in h){let{get:t,set:r}=Object.getOwnPropertyDescriptor(h,e);t||r?l(p,e,{set:r,get:t}):p[e]=h[e]}}u.prototype=p;var f=(d=d.replace(/<!--.+?-->/g,"")).match(/{{.+?}}/g);f&&f.forEach(e=>{var t=/{{(.+?)}}/.exec(e);t&&(d=d.replace(e,`<xv-span svkey="${t[1].trim()}"></xv-span>`))}),s[c]=n({},a,{XHear:u,temp:d}),r(a.tag+"[xv-ele]").each((e,t)=>{N(t)})};j.register=K;const V=(e,t)=>{let a=0,s=[],{prevObject:n}=e;return t?e.each((e,r)=>{d(r,"xv-shadow")&&r.getAttribute("xv-shadow")==t&&(s.push(r),a=1)}):e.each((e,t)=>{d(t,"xv-shadow")?a=1:s.push(t)}),a&&(e=r(s),n&&(e.prevObject=n)),e},X=(e,t)=>{let r=e[0].tagName.toLowerCase(),a=s[r],n=new Set([...Object.keys(a.data),...a.props,...a.attrs]);p(n,r=>{e[r]=t[r]})},G=e=>{let t=e.attr("xv-render");t&&(e.find(`[xv-shadow="${t}"]:not([xv-content])`).remove(),e.find(`[xv-shadow="${t}"][xv-content]`).each((e,t)=>{r(t).before(t.childNodes).remove()}));e.find("[xv-render]").each((e,t)=>{G(r(t))})},z=(e,t)=>{let a=u(t);if(e.is("[xv-shadow]")){let s=e.attr("xv-shadow");if("string"==a&&t.search("<")>-1){let e=r(t);e.attr("xv-shadow",s),e.find("*").attr("xv-shadow",s),t="",p(e,e=>{t+=e.outerHTML})}else a instanceof Element?r(t).attr("xv-shadow",s):t instanceof j&&r(Array.from(t)).attr("xv-shadow",s)}return t},Q=e=>(e.is("[xv-render]")&&(e=e.map((e,t)=>{let r=t,a=t[v];for(;a&&a.$content;)a=(r=a.$content[0]).xvData;return r})),e);n(g,{add(...t){let r=t[0];if(r instanceof e.$&&r.is("xv-shadow"))throw"shadow element can't use add";return a.add.apply(this,t)},attr(...e){let[t,s]=e;return s&&this.is("[xv-render]")?(this.each((n,i)=>{let l=x(i);l&&l.attrs.indexOf(t)>-1?i[v][t]=s:a.attr.apply(r(i),e)}),this):a.attr.apply(this,e)},clone(...e){if(this.is("[xv-shadow]"))throw"shadow element can't use clone";if(this.svRender){let e=this.html(),t=r(`<div>${e}</div>`);t.find("[xv-render]").each((e,t)=>{r(t).removeAttr("xv-render").attr("xv-ele","")}),e=t.html();this[0].tagName.toLowerCase();let a=this[0].cloneNode();r(a).removeAttr("xv-render").attr("xv-ele","").html(e),N(a);let s=w(a);X(s,this);let n=r("[xv-render]:not([xv-shadow])",this);if(0 in n){let e=r("[xv-render]:not([xv-shadow])",s);e.length==n.length&&e.each((e,t)=>{let r=n[e];if(r.tagName!==t.tagName)return console.warn("cloned xv-ele data does not match"),!1;X(w(t),w(r))})}return s}{let t=this.is("[xv-render]"),s=0 in this.find("[xv-render]");if(t||s){let t=r(Array.from(this)),a=t.clone(...e);G(a),a.find("[xv-render]").removeAttr("xv-render").attr("xv-ele",""),b(a),t.each((e,t)=>{d(t,"xv-render")&&(a[e]=w(t).clone()[0])});let s=e=>{let r=a.find(e);if(0 in r){let a=t.find(e);r.length==a.length&&a.each((e,t)=>{X(w(r[e]),w(t))})}};return s("[xv-render]:not([xv-shadow])"),s("[xv-render][xv-shadow]"),this.prevObject&&(a.prevObject=this),m(a)}a.clone.apply(this,e)}},empty(){return a.empty.call(Q(this)),this},parent(e){let t=this.map((e,t)=>{let r=t.parentNode;for(;r.svParent;)r=r.svParent;return r}),r=m(Array.from(new Set(t)));return e&&(r=r.filter(e)),r},parents(e){let t=[];this.each((e,r)=>{let a=r.parentNode;for(;a&&a!==document;){for(;a.svParent;)a=a.svParent;t.push(a),a=a.parentNode}});let r=m(Array.from(new Set(t)));return e&&(r=r.filter(e)),r},parentsUntil(e){let t=[];return this.each((a,s)=>{let n=s.parentNode;for(;n&&n!==document;){for(;n.svParent;)n=n.svParent;if(e&&r(n).is(e))break;t.push(n),n=n.parentNode}}),m(new Set(t))},unwrap(){let e=r(this).parent();return e.is("[xv-content]")?e.each((e,t)=>{let{svParent:a}=t;a=r(a?a:t);let s=t.childNodes;p(s,e=>{a.before(e)}),a.remove()}):a.unwrap.call(this),this},findReal(...e){return m(a.find.apply(this,e))},findShadow(...e){let t=a.find.apply(this,e);return t=V(t,this.attr("xv-render")),m(t)}}),p(["after","before","wrap","wrapAll","replaceWith"],e=>{let t=a[e];t&&(g[e]=function(e){return t.call(this,z(this,e)),b(this.parent()),this})}),p(["insertAfter","insertBefore","replaceAll"],e=>{let t=a[e];t&&(g[e]=function(a){if(this.is("[xv-shadow]"))throw"shadow element can't use "+e;return t.call(z(r(a),this),a),this})}),p(["append","prepend","wrapInner"],e=>{let t=a[e];t&&(g[e]=function(e){return t.call(Q(this),z(this,e)),b(this),this})}),p(["appendTo","prependTo"],e=>{let t=a[e];t&&(g[e]=function(a){if(this.is("[xv-shadow]"))throw"shadow element can't use "+e;let s=r(a);return s.is("[xv-shadow]")&&z(s,this),t.call(this,Q(s)),this})}),p(["find","children"],e=>{let t=a[e];t&&(g[e]=function(e){let r=t.call(Q(this),e);return 1==r.length&&r[0][v]?r=w(r[0]):(r=this.is("[xv-shadow]")?V(r,this.attr("xv-shadow")):V(r),r=m(r)),r})}),p(["eq","first","last","filter","has","not","slice","next","nextAll","nextUntil","prev","prevAll","prevUntil","siblings"],e=>{a[e]&&(g[e]=function(...t){let r=a[e].apply(this,t);return r=m(r)})}),p(["html","text"],e=>{let t=a[e];t&&(g[e]=function(a){let s=this;if((e=>void 0===e)(a)){let e=r(s[0]);if(0 in e.find("[xv-shadow]")){let a=r(e[0].cloneNode(!0));return G(a),t.call(a)}return t.call(e)}return"text"!==e&&(a=z(this,a)),s=t.call(Q(this),a),b(this),s})}),(()=>{let{pushStack:e}=a;e&&(g.pushStack=function(...t){return m(e.apply(this,t))})})();const Y={register:K};e.xhear=Y,e.$=j,r(()=>{const e=e=>{if(e[y])return;let t=x(e);t.attached&&t.attached.call(e,w(e)),e[y]=1},t=e=>{if(e.getRootNode()!=document){let t=x(e);t.detached&&t.detached.call(e,w(e)),r("[xv-content]",e).each((e,t)=>{delete t.svParent});let a=e[v];a&&(a.__obs&&a.__obs.disconnect(),delete a.__obs,delete e[v])}};new MutationObserver(a=>{a.forEach(a=>{let{addedNodes:s,removedNodes:n}=a;s&&0 in s&&p(s,t=>{t[v]&&e(t),t instanceof Element&&p(t.querySelectorAll("[xv-render]"),t=>{e(t)})}),n&&0 in n&&p(n,e=>{e[v]&&t(e),r("[xv-render]",e).each((e,r)=>{t(r)})})})}).observe(document.body,{attributes:!1,childList:!0,characterData:!1,subtree:!0}),r("[xv-ele]").each((e,t)=>{N(t)})}),r("head").append("<style>[xv-ele]{display:none}</style>")})(window);