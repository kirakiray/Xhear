(e=>{"use strict";function t(e,t,r){h(this,{_id:{value:v()},_obs:{value:[]},_trend:{value:[]},_syncs:{value:[]},_watch:{value:{}},_canEmitWatch:{writable:!0,value:0},isRoot:{value:!!e}}),e?(o(this,"_root",{value:e}),o(this,"_host",{value:{target:t,key:r}})):o(this,"_cache",{value:{}})}function r(...e){t.apply(this,e)}let n=e.$,a=n.fn,s={};e.tagDatabase=s;const{assign:i,create:l,defineProperty:o,defineProperties:h}=Object;let c=e=>void 0!==e&&null!==e;const d=(e,t)=>{if(!e.getAttribute)return!1;let r=e.getAttribute(t);return null!==r&&void 0!==r||void 0};let u=Object.prototype.toString;const f=e=>u.call(e).toLowerCase().replace(/(\[object )|(])/g,""),p=(e,t)=>Array.from(e).forEach(t),v=()=>Math.random().toString(32).substr(2),x=((()=>{let e=!1,t=[]})(),v(),v()+"_xhearobj"),y=v()+"_attached",w=e=>{let t=e.tagName.toLowerCase();return s[t]},b=e=>{let t=e[x],r=l(t);return r.push(e),r},g=e=>1==e.length&&e[0][x]?b(e[0]):(e=>{let t=l(_);return t.splice(-1,0,...e),e.prevObject&&(t.prevObject=e.prevObject),t})(e),m=e=>{e.is("[xv-ele]")&&e.each((e,t)=>{O(t)}),n("[xv-ele]",Array.from(e)).each((e,t)=>{O(t)})};let _=l(a),k=100;const O=e=>{if(!d(e,"xv-ele"))return;let t=w(e);if(!t)return void console.warn("no exist tag",e);let r=n(e),a=Array.from(e.childNodes);e.innerHTML=t.temp;let s=++k,l=new t.XHear;l._canEmitWatch=1;let h=new Proxy(l,P);e[x]=h;let u=b(e);r.removeAttr("xv-ele").attr("xv-render",s),r.find("*").attr("xv-shadow",s),n(`[xv-ele][xv-shadow="${s}"]`,e).each((e,t)=>{O(t)}),n(`xv-span[xv-shadow="${s}"]`,e).each((e,t)=>{var r=document.createTextNode("");t.parentNode.insertBefore(r,t),t.parentNode.removeChild(t);var n=t.getAttribute("svkey");h.watch(n,e=>{r.textContent=e})});let p=n(`[xv-content][xv-shadow="${s}"]`,e);if(0 in p&&(o(h,"$content",{enumerable:!0,get:()=>g(p)}),p.prop("svParent",e),p.append(a),t.childChange)){let r=new MutationObserver(r=>{r.forEach(r=>{let{addedNodes:n,removedNodes:a}=r,s={};0 in n&&(s.addedNodes=Array.from(n)),0 in a&&(s.removedNodes=Array.from(a)),t.childChange(b(e),s)})});r.observe(p[0],{attributes:!1,childList:!0,characterData:!1,subtree:!1}),h.__obs=r}n(`[xv-tar][xv-shadow="${s}"]`,e).each((e,t)=>{let r=n(t).attr("xv-tar");o(h,"$"+r,{enumerable:!0,get:()=>g([t])})});let v=i({},t.data);t.attrs.forEach(e=>{let t=r.attr(e);c(t)&&(v[e]=t),h.watch(e,t=>{r.attr(e,t)})}),t.props.forEach(e=>{let t=r.attr(e);c(t)&&(v[e]=t)}),n(`[xv-module][xv-shadow="${s}"]`,e).each((e,t)=>{let r=n(t),a=r.attr("xv-module");h.watch(a,e=>{t.value=e}),t[x]?t[x].watch("value",e=>{h[a]=e}):r.on("change input",e=>{h[a]=t.value})}),r.removeAttr("xv-ele").attr("xv-render",s);let m=t.watch;if(m)for(let e in m)e in v||(v[e]=void 0);if(l._exkeys=Object.keys(v),m)for(let e in m){let t,r,n=m[e];switch(f(n)){case"function":r=n;break;case"object":t=n.get,r=n.set}t&&watchGetter(h,e,t.bind(u)),r&&h.watch(e,r.bind(u))}"value"in v&&o(e,"value",{get:()=>h.value,set(e){h.value=e}});for(let e in v)c(v[e])&&(h[e]=v[e]);t.inited&&t.inited.call(e,u),t.attached&&e.getRootNode()===document&&!e[y]&&(t.attached.call(e,u),e[y]=1)};let j=function(...e){let t=n(...e),[r,a]=e;("string"==f(r)&&r.search("<")>-1||r instanceof Element)&&m(t);let s;return a&&(a.getAttribute?s=a.getAttribute("xv-shadow"):a.attr&&(s=a.attr("xv-shadow"))),t=s?T(t,s):T(t),t=g(t)};j.prototype=a,i(j,{init:(...e)=>g(e)},n);let A=e=>e instanceof t||e instanceof r,N=e=>{let t=e;if(e instanceof Array)t=[],e.forEach(e=>{A(e)?t.push(N(e)):t.push(e)});else if(e instanceof Object){t={};for(let r in e){let n=e[r];A(n)?t[r]=N(n):t[r]=n}}return t};let E=(e,t,r,n,a="update",s)=>{if(!e._canEmitWatch)return;if("uphost"!==a&&r===n)return;if("update"==a&&A(r)&&A(n)&&r.stringify()===n.stringify())return;let l=e._watch[t];l&&l.forEach(e=>{let t={oldVal:n,type:a};t.uphost=i({},s),e(r,t)}),e._obs.forEach(l=>{let o={target:e,type:a,key:t,val:r,oldVal:n};o.uphost=i({},s),l(o)});let{_host:o}=e;if("uphost"!==a){let{_trend:s,_host:l}=e,o=[],h=t;for(;s;){o.unshift(h);let e={key:o,val:N(r),oldVal:N(n),type:a};if(s.forEach(t=>{t(i({},e))}),l){let t=l.target[l.key];E(l.target,l.key,t,t,"uphost",e),s=l.target._trend,h=l.key,l=l.target._host}else s=null}}},P={set(e,t,r,n){if(/^_.+/.test(t))return Reflect.set(e,t,r,n);{let a=e[t],s=e.hasOwnProperty(t)?"update":"new";A(r)&&(r=r.toObject()),r=W(r,e._root||e,e,t);let i=!0;return e._exkeys?e._exkeys.indexOf(t)>-1?(e[t]=r,E(e,t,r,a,s)):i=Reflect.set(e,t,r,n):(i=Reflect.set(e,t,r,n),E(e,t,r,a,s)),i}},deleteProperty(e,t){if(/^_.+/.test(t))return Reflect.deleteProperty(e,t);{let r=e[t],n=Reflect.deleteProperty(e,t);return E(e,t,void 0,r,"delete"),n}}};const $=(e,t)=>{let r,n,a=t.key.length-1;return t.key.forEach((t,s)=>{e instanceof Object&&s<=a&&(s==a&&(r=e,n=t),e=e[t])}),[r,n]},R=(e,t,r="_id")=>{let n=[];if(A(e)){t&&e[r]==t?n.push(e):!t&&e.hasOwnProperty(r)&&n.push(e);let a=S(e,t,r);n.splice(0,0,...a)}return n},S=(e,n,a="_id")=>{let s=[];if(e instanceof t)if("_id"==a){for(let t in e)if(0 in(s=R(e[t],n,a)))break}else for(let t in e){let r=R(e[t],n,a);s.splice(s.length,0,...r)}else e instanceof r&&("_id"==a?e.some(e=>{if(0 in(s=R(e,n,a)))return!0}):e.forEach(e=>{let t=R(e,n,a);s.splice(s.length,0,...t)}));return s};let C={watch(e,t){switch(f(e)){case"string":let r=this._watch[e]||(this._watch[e]=[]);t&&r.push(t);break;case"object":for(let t in e)this.watch(t,e[t])}return this},unwatch(e,t){switch(f(e)){case"string":let r=this._watch[e]||(this._watch[e]=[]),n=r.indexOf(t);n>-1&&r.splice(n,1);break;case"object":for(let t in e)this.watch(t,e[t])}return this},observe(e){return e&&this._obs.push(e),this},unobserve(e){let t=this._obs.indexOf(e);return t>-1&&this._obs.splice(t,1),this},reset(e,t){if(t){if(t.watch)for(let e in this._watch)delete this._watch[e];t.obs&&(this._obs.length=0),t.trend&&(this._trend.length=0),sync&&(this._syncs.length=0)}for(let e in this)delete this[e];i(this,e)},trend(e){return e&&this._trend.push(e),this},entrend(e){let[t,r]=$(this,e);switch(e.type){case"delete":delete t[r];break;default:t[r]=e.val}return this},untrend(e){let t=this._trend.indexOf(e);return t>-1&&this._trend.splice(t,1),this},sync(e,t){return e.reset(this.toObject()),((e,t,r)=>{let n,a,s=f(r);switch(s){case"string":n=(e=>{let n=e.key[0];r===n&&t.entrend(e)}),a=(t=>{let n=t.key[0];r===n&&e.entrend(t)});break;case"array":n=(e=>{let n=e.key[0];r.indexOf(n)>-1&&t.entrend(e)}),a=(t=>{let n=t.key[0];r.indexOf(n)>-1&&e.entrend(t)});break;case"object":let i=Object.keys(r),l=Object.values(r);n=(e=>{let r=e.key[0];i.indexOf(r)>-1&&((e=Object.assign({},e)).key[0]=l[i.indexOf(r)],t.entrend(e))}),a=(t=>{let r=t.key[0];l.indexOf(r)>-1&&((t=Object.assign({},t)).key[0]=i[l.indexOf(r)],e.entrend(t))});break;default:n=(e=>t.entrend(e)),a=(t=>e.entrend(t))}e.trend(n),t.trend(a);let i=v();e._syncs.push({bid:i,type:s,func:n,opp:t}),t._syncs.push({bid:i,type:s,func:a,opp:e})})(this,e,t),this},unsync(e,t){return((e,t,r)=>{let n=f(r),a=e._syncs.find(e=>e.opp===t&&e.type===n);if(a){let{bid:r}=a,n=e._syncs.find(e=>e.bid==r),s=t._syncs.find(e=>e.bid==r);e._syncs.splice(n,1);let i=t._syncs.splice(s,1);i=i[0],e.untrend(a.func),t.untrend(i.func)}})(this,e,t),this},transData(e){let t={key:"",target:"",targetKey:""};i(t,e);let{key:r,target:n,targetKey:a,trans:s}=t;if(t.trans){let e={};for(let t in s)e[s[t]]=t;this.watch(r,e=>{e=s[e],n[a]=e}),n.watch(a,t=>{t=e[t],this[r]=t})}},toObject(){return N(this)},stringify(){let e=N(this);return JSON.stringify(e)},seek(e){let t,r=e.match(/\[.+?\]/g);if(r){let e=(e,r)=>{if(0===e)t=r;else{let e=[];r.forEach(r=>{t.indexOf(r)>-1&&e.push(r)}),t=e}};r.forEach((t,r)=>{if(t.search("=")>-1){let n=t.match(/\[(.+?)=(.+?)\]/),a=n[1],s=n[2],i=R(this,s,a);e(r,i)}else{let n=t.replace("[","").replace("]","").replace("=",""),a=R(this,void 0,n);e(r,a)}}),e=null}else t=R(this,e)[0];return t}};for(let e in C)o(t.prototype,e,{value:C[e]});let L=Object.create(Array.prototype);for(let e in C)o(L,e,{value:C[e]});r.prototype=L;let W=(e,n,a,s)=>{switch(f(e)){case"object":return((e,r,n,a)=>{let s=new t(r,n,a),l=new Proxy(s,P);return i(l,e),s._canEmitWatch=1,l})(e,n,a,s);case"array":return((e,t,n,a)=>{let s=new r(t,n,a),i=new Proxy(s,P);return Array.prototype.splice.call(i,0,0,...e),s._canEmitWatch=1,i})(e,n,a,s)}return e};j.xdata=(e=>W(e)),j.detrend=$;let D=Object.create(_);D.svRender=!0;for(let e in C)o(D,e,{value:C[e]});o(D,"set",{value(e,t){-1===this._exkeys.indexOf(e)&&this._exkeys.push(e),this[e]=t}});const M=e=>{let r={tag:"",temp:"",attrs:[],props:[],data:{},watch:{}};i(r,e);let{proto:a,props:o,temp:h,tag:c}=r;o.push("value");let d=function(...e){t.apply(this,e)},u=D;a&&(u=l(D),i(u,a)),d.prototype=u;var f=(h=h.replace(/<!--.+?-->/g,"")).match(/{{.+?}}/g);f&&f.forEach(e=>{var t=/{{(.+?)}}/.exec(e);t&&(h=h.replace(e,`<xv-span svkey="${t[1].trim()}"></xv-span>`))}),s[c]=i({},r,{XHear:d,temp:h}),n(r.tag+"[xv-ele]").each((e,t)=>{O(t)})};j.register=M;const T=(e,t)=>{let r=0,a=[],{prevObject:s}=e;return t?e.each((e,n)=>{d(n,"xv-shadow")&&n.getAttribute("xv-shadow")==t&&(a.push(n),r=1)}):e.each((e,t)=>{d(t,"xv-shadow")?r=1:a.push(t)}),r&&(e=n(a),s&&(e.prevObject=s)),e},H=(e,t)=>{let r=e[0].tagName.toLowerCase(),n=s[r],a=new Set([...Object.keys(n.data),...n.props,...n.attrs]);p(a,r=>{e[r]=t[r]})},U=e=>{let t=e.attr("xv-render");t&&(e.find(`[xv-shadow="${t}"]:not([xv-content])`).remove(),e.find(`[xv-shadow="${t}"][xv-content]`).each((e,t)=>{n(t).before(t.childNodes).remove()}));e.find("[xv-render]").each((e,t)=>{U(n(t))})},V=(e,t)=>{let r=f(t);if(e.is("[xv-shadow]")){let a=e.attr("xv-shadow");if("string"==r&&t.search("<")>-1){let e=n(t);e.attr("xv-shadow",a),e.find("*").attr("xv-shadow",a),t="",p(e,e=>{t+=e.outerHTML})}else r instanceof Element?n(t).attr("xv-shadow",a):t instanceof j&&n(Array.from(t)).attr("xv-shadow",a)}return t},q=e=>(e.is("[xv-render]")&&(e=e.map((e,t)=>{let r=t,n=t[x];for(;n&&n.$content;)n=(r=n.$content[0]).xvData;return r})),e);i(_,{add(...t){let r=t[0];if(r instanceof e.$&&r.is("xv-shadow"))throw"shadow element can't use add";return a.add.apply(this,t)},attr(...e){let[t,r]=e;return r&&this.is("[xv-render]")?(this.each((s,i)=>{let l=w(i);l&&l.attrs.indexOf(t)>-1?i[x][t]=r:a.attr.apply(n(i),e)}),this):a.attr.apply(this,e)},clone(...e){if(this.is("[xv-shadow]"))throw"shadow element can't use clone";if(this.svRender){let e=this.html(),t=n(`<div>${e}</div>`);t.find("[xv-render]").each((e,t)=>{n(t).removeAttr("xv-render").attr("xv-ele","")}),e=t.html();this[0].tagName.toLowerCase();let r=this[0].cloneNode();n(r).removeAttr("xv-render").attr("xv-ele","").html(e),O(r);let a=b(r);H(a,this);let s=n("[xv-render]:not([xv-shadow])",this);if(0 in s){let e=n("[xv-render]:not([xv-shadow])",a);e.length==s.length&&e.each((e,t)=>{let r=s[e];if(r.tagName!==t.tagName)return console.warn("cloned xv-ele data does not match"),!1;H(b(t),b(r))})}return a}{let t=this.is("[xv-render]"),r=0 in this.find("[xv-render]");if(t||r){let t=n(Array.from(this)),r=t.clone(...e);U(r),r.find("[xv-render]").removeAttr("xv-render").attr("xv-ele",""),m(r),t.each((e,t)=>{d(t,"xv-render")&&(r[e]=b(t).clone()[0])});let a=e=>{let n=r.find(e);if(0 in n){let r=t.find(e);n.length==r.length&&r.each((e,t)=>{H(b(n[e]),b(t))})}};return a("[xv-render]:not([xv-shadow])"),a("[xv-render][xv-shadow]"),this.prevObject&&(r.prevObject=this),g(r)}a.clone.apply(this,e)}},empty(){return a.empty.call(q(this)),this},parent(e){let t=this.map((e,t)=>{let r=t.parentNode;for(;r.svParent;)r=r.svParent;return r}),r=g(Array.from(new Set(t)));return e&&(r=r.filter(e)),r},parents(e){let t=[];this.each((e,r)=>{let n=r.parentNode;for(;n&&n!==document;){for(;n.svParent;)n=n.svParent;t.push(n),n=n.parentNode}});let r=g(Array.from(new Set(t)));return e&&(r=r.filter(e)),r},parentsUntil(e){let t=[];return this.each((r,a)=>{let s=a.parentNode;for(;s&&s!==document;){for(;s.svParent;)s=s.svParent;if(e&&n(s).is(e))break;t.push(s),s=s.parentNode}}),g(new Set(t))},unwrap(){let e=n(this).parent();return e.is("[xv-content]")?e.each((e,t)=>{let{svParent:r}=t;r=n(r?r:t);let a=t.childNodes;p(a,e=>{r.before(e)}),r.remove()}):a.unwrap.call(this),this},findReal(...e){return g(a.find.apply(this,e))},findShadow(...e){let t=a.find.apply(this,e);return t=T(t,this.attr("xv-render")),g(t)}}),p(["after","before","wrap","wrapAll","replaceWith"],e=>{let t=a[e];t&&(_[e]=function(e){return t.call(this,V(this,e)),m(this.parent()),this})}),p(["insertAfter","insertBefore","replaceAll"],e=>{let t=a[e];t&&(_[e]=function(r){if(this.is("[xv-shadow]"))throw"shadow element can't use "+e;return t.call(V(n(r),this),r),this})}),p(["append","prepend","wrapInner"],e=>{let t=a[e];t&&(_[e]=function(e){return t.call(q(this),V(this,e)),m(this),this})}),p(["appendTo","prependTo"],e=>{let t=a[e];t&&(_[e]=function(r){if(this.is("[xv-shadow]"))throw"shadow element can't use "+e;let a=n(r);return a.is("[xv-shadow]")&&V(a,this),t.call(this,q(a)),this})}),p(["find","children"],e=>{let t=a[e];t&&(_[e]=function(e){let r=t.call(q(this),e);return 1==r.length&&r[0][x]?r=b(r[0]):(r=this.is("[xv-shadow]")?T(r,this.attr("xv-shadow")):T(r),r=g(r)),r})}),p(["eq","first","last","filter","has","not","slice","next","nextAll","nextUntil","prev","prevAll","prevUntil","siblings"],e=>{a[e]&&(_[e]=function(...t){let r=a[e].apply(this,t);return r=g(r)})}),p(["html","text"],e=>{let t=a[e];t&&(_[e]=function(r){let a=this;if((e=>void 0===e)(r)){let e=n(a[0]);if(0 in e.find("[xv-shadow]")){let r=n(e[0].cloneNode(!0));return U(r),t.call(r)}return t.call(e)}return"text"!==e&&(r=V(this,r)),a=t.call(q(this),r),m(this),a})}),(()=>{let{pushStack:e}=a;e&&(_.pushStack=function(...t){return g(e.apply(this,t))})})();const B={register:M};e.xhear=B,e.$=j,n(()=>{const e=e=>{if(e[y])return;let t=w(e);t.attached&&t.attached.call(e,b(e)),e[y]=1},t=e=>{if(e.getRootNode()!=document){let t=w(e);t.detached&&t.detached.call(e,b(e)),n("[xv-content]",e).each((e,t)=>{delete t.svParent});let r=e[x];r&&(r.__obs&&r.__obs.disconnect(),delete r.__obs,delete e[x])}};new MutationObserver(r=>{r.forEach(r=>{let{addedNodes:a,removedNodes:s}=r;a&&0 in a&&p(a,t=>{t[x]&&e(t),t instanceof Element&&p(t.querySelectorAll("[xv-render]"),t=>{e(t)})}),s&&0 in s&&p(s,e=>{e[x]&&t(e),n("[xv-render]",e).each((e,r)=>{t(r)})})})}).observe(document.body,{attributes:!1,childList:!0,characterData:!1,subtree:!0}),n("[xv-ele]").each((e,t)=>{O(t)})}),n("head").append("<style>[xv-ele]{display:none}</style>")})(window);