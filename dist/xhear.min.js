(e=>{"use strict";const t=()=>Math.random().toString(32).substr(2);let s=Object.prototype.toString;const r=e=>s.call(e).toLowerCase().replace(/(\[object )|(])/g,""),a=e=>void 0===e,i=e=>JSON.parse(JSON.stringify(e)),n=(()=>{let e=!1,s=new Map;return(r,a)=>{e||(e=!0,setTimeout(()=>{s.size&&s.forEach(e=>{e()}),s.clear(),e=!1},0)),a||(a=t()),s.set(a,r)}})(),l=(e,s,r,a)=>{let n;n=e._modifyId?e._modifyId:t(),S(e,k).push(n),o(e);let l=new y({type:"update",target:e[j]||e});Object.defineProperties(l,{trend:{get:()=>new I(l)}}),a&&Object.assign(l,a),l.modify={name:s,args:i(r),mid:n},e.emit(l)};let c,h=new Set;const o=e=>{e[k].length<50||(clearTimeout(c),h.add(e),c=setTimeout(()=>{let e=Array.from(h);setTimeout(()=>{e.forEach(e=>o(e))},1e3),h.forEach(e=>{let t=e[k];t.splice(0,Math.ceil(t.length/2))}),h.clear()},3e3))},f=e=>{if(!(e instanceof A))return;let t=e[w];if(t&&(t.index=void 0,t.parent=void 0),e instanceof W){let{mappingXData:s}=e,r=s[D].find(e=>e.data===t),{leftUpdate:a,rightUpdate:i}=r;e.off("update",i),s.off("update",a),t.mappingXData=null}if(t[E])for(let[e,s]of t[E])t.unsync(e);t[D]&&(t[D].forEach(e=>{let{data:s,leftUpdate:r,rightUpdate:a}=e;s.off("update",a),t.off("update",r),s.mappingXData=null}),t[D].splice(0)),t[O]&&t[O].clear(),t[p]&&t[p].clear()},d=(e,t)=>{let s=e;switch(r(e)){case"object":case"array":s=new A(e,t)}return s},p=Symbol("events"),u=(e,t)=>{let s=t[p];s||(s=new Map,Object.defineProperty(t,p,{value:s}));let r=s.get(e);return r||(r=[],s.set(e,r)),r},g=(e,t,s)=>{let r;e instanceof y?e=(r=e).type:r=new y({type:e,target:s[j]||s});let a=u(e,s),i=[];return r.currentTarget=s[j]||s,a.some(e=>{if(e.data&&(r.data=e.data),e.eventId&&(r.eventId=e.eventId),e.callback.call(s[j]||s,r,t),delete r.data,delete r.eventId,e.count--,e.count||i.push(e),r.cancel)return!0}),delete r.currentTarget,i.forEach(e=>{let t=a.indexOf(e);t>-1&&a.splice(t,1)}),r};class b{constructor(e={}){Object.defineProperties(this,{parent:{writable:!0,value:e.parent,configurable:!0},index:{writable:!0,value:e.index,configurable:!0}})}on(e,t,s){this.addListener({type:e,data:s,callback:t})}one(e,t,s){this.addListener({count:1,type:e,data:s,callback:t})}addListener(e={}){let{type:t,data:s,callback:r,count:i=1/0,eventId:n}=e;if(!t)throw{desc:"addListener no type",options:e};let l=t.split("#");1 in l&&(t=l[0],n=l[1]);let c=u(t,this);a(n)||Array.from(c).some(e=>{if(e.eventId===n){let t=c.indexOf(e);return t>-1&&c.splice(t,1),!0}}),r&&c.push({type:t,data:s,callback:r,eventId:n,count:i})}off(e,t){if(e)if(t){let s=u(e,this),r=s.findIndex(e=>e.callback==t);r>-1&&s.splice(r,1)}else this[p]&&this[p].delete(e)}emitHandler(e,t){g(e,t,this)}emit(e,t){let s=g(e,t,this);if(s.bubble&&!s.cancel){let{parent:e}=this;e&&(s.keys.unshift(this.index),e.emit(s,t))}}}class y extends b{constructor(e){super(),this.type=e.type,this.target=e.target,this._bubble=!0,this._cancel=!1,this.keys=[]}get bubble(){return this._bubble}set bubble(e){this._bubble!==e&&(this.emitHandler("set-bubble",e),this._bubble=e)}get cancel(){return this._cancel}set cancel(e){this._cancel!==e&&(this.emitHandler("set-cancel",e),this._cancel=e)}}const m=/^_.+|^index$|^length$|^object$|^getData$|^setData$/,x=/^parent$|^index$|^length$|^object$/;let v={get:(e,t,s)=>"symbol"==typeof t||m.test(t)?Reflect.get(e,t,s):e.getData(t),set:(e,t,s,r)=>"symbol"==typeof t?Reflect.set(e,t,s,r):e.setData(t,s)};const j=Symbol("proxyThis"),w=Symbol("XDataSelf"),O=Symbol("WatchHost"),k=Symbol("ModifyIDS"),E=Symbol("SyncHost"),D=Symbol("VirDataHost"),S=(e,t)=>{let s=e[t];if(!s){switch(t){case O:case E:s=new Map;break;case k:case D:s=[]}Object.defineProperty(e,t,{value:s})}return s};class A extends b{constructor(e,t={}){super(t);let s=new Proxy(this,v),r=0;Object.keys(e).forEach(t=>{if(/^\_/.test(t))return void Object.defineProperty(this,t,{configurable:!0,writable:!0,value:e[t]});let s=e[t];/\D/.test(t)||(t=parseInt(t))>=r&&(r=t+1),s instanceof Object?this[t]=new A(s,{parent:this,index:t}):this[t]=s}),Object.defineProperties(this,{[w]:{get:()=>this},[j]:{value:s},_modifyId:{value:null,writable:!0},length:{writable:!0,value:r}})}setData(e,t){if(x.test(e))return console.warn("you can't set this key in XData => ",e),!1;if(/^_.+/.test(e))return Object.defineProperty(this,e,{configurable:!0,writable:!0,value:t}),!0;let s=this[w];if("string"===r(e)){let r=s[e];if(t===r)return;t instanceof A?((t=t[w]).remove(),t.parent=s,t.index=e):t instanceof Object&&(t=d(t,{parent:s,index:e})),s[e]=t,l(s,"setData",[e,t],{oldValue:r})}else if(e instanceof Object){let t=e;return Object.keys(t).forEach(e=>{let r=t[e];s.setData(e,r)}),!0}}getData(e){let t=this[e];return t instanceof A&&(t=t[j]),t}remove(e){if(a(e)){let{parent:e}=this;e?e.remove(this.index):f(this)}else{let t=this[e];/\D/.test(e)?(delete this[e],f(t),l(this,"remove",[e])):this.splice(parseInt(e),1)}}add(e){!this.includes(e)&&this.push(e)}delete(e){let t=this.indexOf(e);t>-1&&this.splice(t,1)}has(e){return this.includes(e)}clear(){this.splice(0,this.length)}before(e){if(/\D/.test(this.index))throw{text:"It must be an array element",target:this,index:this.index};return this.parent.splice(this.index,0,e),this}after(e){if(/\D/.test(this.index))throw{text:"It must be an array element",target:this,index:this.index};return this.parent.splice(this.index+1,0,e),this}clone(){return d(i(this))[j]}get object(){let e={},t=!0;return Object.keys(this).forEach(s=>{if(/^_/.test(s)||!/\D/.test(s))return;t=!1;let r=this[s];r instanceof A&&(r=r.object),e[s]=r}),this.forEach((t,s)=>{t instanceof A&&(t=t.object),e[s]=t}),t&&(e.length=this.length,e=Array.from(e)),e}get string(){return JSON.stringify(this.object)}get root(){let e=this;for(;e.parent;)e=e.parent;return e}get prev(){if(!/\D/.test(this.index)&&this.index>0)return this.parent.getData(this.index-1)}get next(){if(!/\D/.test(this.index))return this.parent.getData(this.index+1)}getTarget(e){let t=this;return e.length&&e.forEach(e=>{t=t[e]}),t}seek(e){let t=r(e);if("function"===t){let t=[],s=s=>{if(s instanceof A){e(s)&&t.push(s);let r=s.seek(e);t=[...t,...r]}};return Object.keys(this).forEach(e=>{/\D/.test(e)&&s(this[e])}),this.forEach(s),s=null,t}if("string"===t){let t,s=(e=e.replace(/[\[\]]/g,"")).split("=");if(2==s.length){let[e,r]=s;t=(t=>t[e]==r)}else{let[e]=s;t=(t=>Object.keys(t).includes(e))}return this.seek(t)}}watch(e,t,s){let a=r(e);if("object"===a)return void Object.keys(e).forEach(t=>{this.watch(t,e[t])});/function/.test(a)&&(t=e,e="");let i;i=""==e?"watchSelf":/\[.+\]/.test(e)?"seekData":"watchKey";let l=S(this,O).get(e);l||(l=new Set,S(this,O).set(e,l));let c={trends:[],callback:t,expr:e};l.add(c);let h;switch(i){case"watchSelf":h=(e=>{c.trends.push(e.trend),n(()=>{t.call(this,{trends:Array.from(c.trends)},this),c.trends.length=0},c)}),!0===s&&t.call(this,{trends:[]},this);break;case"watchKey":h=(s=>{let{trend:r}=s;r.fromKey==e&&(c.trends.push(s.trend),n(()=>{let s=this[e];t.call(this,{expr:e,val:s,trends:Array.from(c.trends)},s),c.trends.length=0},c))}),!0===s&&t.call(this,{expr:e,val:this[e],trends:[]},this[e]);break;case"seekData":let r=this.seek(e);h=(s=>{n(()=>{let s=this.seek(e),a=1;s.length===r.length?s.some(e=>{if(!r.includes(e))return a=0,!0}):a=0,!a&&t.call(this,{expr:e,old:r,val:s},s),r=s},c)}),!0===s&&t.call(this,{expr:e,old:r,val:r},r)}return this.on("update",h),c.updateMethod=h,this}unwatch(e,t){let s=r(e);if("object"===s)return Object.keys(e).forEach(t=>{this.unwatch(t,e[t])}),this;/function/.test(s)&&(t=e,e="");let a=S(this,O).get(e);if(a){let s=Array.from(a).find(s=>s.callback===t&&s.expr===e);s&&(this.off("update",s.updateMethod),a.delete(s),!a.size&&S(this,O).delete(e))}return this}entrend(e){let{mid:t,keys:s,name:r,args:a}=e;if(!t)throw{text:"Illegal trend data"};if(S(this,k).includes(t))return!1;let i=this.getTarget(s)[w];return i._modifyId=t,i[r](...a),i._modifyId=null,!0}}class I{constructor(e){if(e instanceof y){let{modify:{name:t,args:s,mid:r},keys:a}=i(e);Object.assign(this,{name:t,args:s,mid:r,keys:a})}else Object.assign(this,e)}get string(){return JSON.stringify(this)}get finalSetterKey(){switch(this.name){case"remove":case"setData":return this.args[0]}}get fromKey(){let e=this.keys[0];return!a(e)||"setData"!==this.name&&"remove"!==this.name||(e=this.args[0]),e}set fromKey(e){let t=this.keys[0];a(t)?"setData"!==this.name&&"remove"!==this.name||(this.args[0]=e):this.keys[0]=e}}const _=(e,t,s)=>{t.trends.forEach(t=>{t.fromKey===e&&s.entrend(t)})},P=(e,t,s)=>{t.trends.forEach(t=>{e.includes(t.fromKey)&&s.entrend(t)})},C=(e,t,s)=>{i(t.trends).forEach(t=>{t=new I(t);let{fromKey:r}=t;if(!a(r)){let a=e.get(r);a&&(t.fromKey=a,s.entrend(t))}})},M=e=>(e instanceof A&&(e=e.object),e),T=(e,t,s)=>{Object.keys(e).forEach(r=>{let a=e[r];if(a instanceof Object){t[r]||(t.setData?t.setData(r,{}):t[r]={});let e=t[r];T(a,e,s)}else{let i=s([r,a],{self:e,target:t});if(i){let[e,s]=i;t[e]=s}}})},H=(e,t,s)=>{let{trend:r}=t;if(r){switch(r.name){case"setData":let e=r.args[1];if(e instanceof Object){let t={};T(e,t,s),r.args[1]=t}else a(e)||(r.args=s(r.args,{event:t}));break;default:r.args=r.args.map(e=>{let t=e;return e instanceof Object&&T(e,t={},s),t})}e.entrend(r)}},L={sync(e,t,s){let a,i;switch(r(t)){case"string":s&&e.setData(t,M(this[t])),a=(s=>_(t,s,e)),i=(e=>_(t,e,this));break;case"array":s&&t.forEach(t=>{e.setData(t,M(this[t]))}),a=(s=>P(t,s,e)),i=(e=>P(t,e,this));break;case"object":let n=new Map(Object.entries(t)),l=new Map(Object.entries(t).map(e=>e.reverse()));s&&Object.keys(t).forEach(s=>{e.setData(t[s],M(this[s]))}),a=(t=>C(n,t,e)),i=(e=>C(l,e,this));break;default:s&&e.setData(this.object),a=(t=>t.trends.forEach(t=>e.entrend(t))),i=(e=>e.trends.forEach(e=>this.entrend(e)))}this.watch(a),e.watch(i);let n=S(this,E);n.has(e)&&this.unsync(e),n.set(e,{selfWatch:a,oppWatch:i}),S(e,E).set(this,{selfWatch:i,oppWatch:a})},unsync(e){let t=S(this,E).get(e);if(t){let{selfWatch:s,oppWatch:r}=t;this.unwatch(s),e.unwatch(r),S(this,E).delete(e),S(e,E).delete(this)}},virData(e,t){let s=new W(this[w],{}),a=r(e),i=e;if("object"==a)if("mapKey"in i){let s=Object.entries(i.mapKey),r=new Map(s),a=new Map(s.map(e=>e.reverse()));e=(([e,t])=>r.has(e)?[r.get(e),t]:[e,t]),t=(([e,t])=>a.has(e)?[a.get(e),t]:[e,t])}else if("mapValue"in i){let s=i.key,r=Object.entries(i.mapValue),a=new Map(r),n=new Map(r.map(e=>e.reverse()));e=(([e,t])=>e===s&&a.has(t)?[e,a.get(t)]:[e,t]),t=(([e,t])=>e===s&&n.has(t)?[e,n.get(t)]:[e,t])}T(this,s,e);let n,l;return this.on("update",n=(t=>H(s,t,e))),s.on("update",l=(e=>H(this,e,t))),S(this,D).push({data:s,leftUpdate:n,rightUpdate:l}),s[j]}};Object.keys(L).forEach(e=>{Object.defineProperty(A.prototype,e,{writable:!0,value:L[e]})});class W extends A{constructor(e,...t){super(...t),Object.defineProperty(this,"mappingXData",{writable:!0,value:e})}}["concat","every","filter","find","findIndex","forEach","map","slice","some","indexOf","lastIndexOf","includes","join"].forEach(e=>{let t=Array.prototype[e];t&&Object.defineProperty(A.prototype,e,{value(...e){return t.apply(this,e)}})}),["pop","push","reverse","splice","shift","unshift"].forEach(e=>{let t=Array.prototype[e];t&&Object.defineProperty(A.prototype,e,{value(...s){let r=[],a=this[w];s.forEach(e=>{if(e instanceof A){let t=e[w];t.remove(),r.push(t)}else{let t=d(e,{parent:a});r.push(t)}});let i=t.apply(a,r);switch(a.forEach((e,t)=>{e instanceof A&&(e.index=t)}),e){case"shift":case"pop":i instanceof A&&f(i);break;case"splice":i.forEach(e=>{e instanceof A&&f(e)})}return l(a,e,s),i}})}),Object.defineProperty(A.prototype,"sort",{value(e){let t=[e],s=this[w],a=Array.from(s);if((e=>r(e).includes("function"))(e)){Array.prototype.sort.call(s,e),s.forEach((e,t)=>{e instanceof A&&(e.index=t)});t=[a.map(e=>e.index)],a=null}else e instanceof Array&&e.forEach((e,t)=>{(s[e]=a[t]).index=e});return l(s,"sort",t),this}});const K=(e,t)=>{if(e===t)return!0;let s=document.createElement("div");return e!==document&&(s.appendChild(e.cloneNode(!1)),!!s.querySelector(t))},N=e=>{if(!e.tag)throw console.error("this data need tag =>",e),"";let t=document.createElement(e.tag);if(e.class&&t.setAttribute("class",e.class),e.text&&(t.textContent=e.text),e.data){let{data:s}=e;Object.keys(s).forEach(e=>{let r=s[e];t.dataset[e]=r})}if(t.xvele){let s=Z(t);s[$].forEach(t=>{let r=e[t];a(r)||(s[t]=r)})}let s=0;for(;s in e;){let r=N(e[s]);t.appendChild(r),s++}return t},$=Symbol("cansetkeys"),X=e=>(/\-/.test(e)&&(e=e.replace(/\-[\D]/g,e=>e.substr(1).toUpperCase())),e),U=e=>(/[A-Z]/.test(e)&&(e=e.replace(/[A-Z]/g,e=>"-"+e.toLowerCase())),e),B=new Set(["text","html","display","style"]),q=new Set(["parent","index"]),J=A.prototype.setData;class V extends A{constructor(e){super({}),delete this.parent,delete this.index,Object.defineProperties(e,{__xhear__:{value:this}}),Object.defineProperties(this,{tag:{enumerable:!0,value:e.tagName.toLowerCase()},ele:{value:e}})}get parent(){let{parentNode:e}=this.ele;return e&&e!==document?Z(e):null}get class(){return this.ele.classList}get data(){return this.ele.dataset}get index(){let{ele:e}=this;return Array.from(e.parentNode.children).indexOf(e)}get css(){return getComputedStyle(this.ele)}get position(){return{top:this.ele.offsetTop,left:this.ele.offsetLeft}}get offset(){let e={top:0,left:0},t=this.ele;for(;t&&t!==document;)e.top+=t.offsetTop,e.left+=t.offsetLeft,t=t.offsetParent;return e}get width(){return parseInt(getComputedStyle(this.ele).width)}get height(){return parseInt(getComputedStyle(this.ele).height)}get innerWidth(){return this.ele.clientWidth}get innerHeight(){return this.ele.clientHeight}get offsetWidth(){return this.ele.offsetWidth}get offsetHeight(){return this.ele.offsetHeight}get outerWidth(){let e=getComputedStyle(this.ele);return this.ele.offsetWidth+parseInt(e["margin-left"])+parseInt(e["margin-right"])}get outerHeight(){let e=getComputedStyle(this.ele);return this.ele.offsetHeight+parseInt(e["margin-top"])+parseInt(e["margin-bottom"])}get text(){return this.ele.innerText}set text(e){this.ele.innerText=e}get html(){return this.ele.innerHTML}set html(e){this.ele.innerHTML=e}get display(){return getComputedStyle(this.ele).display}set display(e){this.ele.style.display=e}get style(){return this.ele.style}set style(e){let{style:t}=this,s=Array.from(t),r=Object.keys(e);s.forEach(e=>{r.includes(e)||(t[e]="")}),Object.assign(t,e)}setData(e,t){if(q.has(e))return console.warn("can't set this key => ",e),!1;e=X(e);let s=this[$];if(B.has(e))return this[w][e]=t,!0;if(/\D/.test(e)){if(s&&s.has(e))return J.call(this,e,t)}else{let s=F(t),r=this.ele.children[e];r?(this.ele.insertBefore(s.ele,r),this.ele.removeChild(r)):this.ele.appendChild(s.ele)}return!1}getData(e){e=X(e);let t,s=this[w];return/\D/.test(e)?t=s[e]:(t=s.ele.children[e])&&(t=Z(t)),t instanceof A&&(t=t[j]),t}siblings(e){let t=Array.from(this.ele.parentElement.children),s=t.indexOf(this.ele);return t.splice(s,1),e&&(t=t.filter(t=>{if(K(t,e))return!0})),t.map(e=>Z(e))}empty(){return this.splice(0,this.length),this}parents(e){let t=[],s=this.parent;if(e){if("string"!=r(e)){if(e instanceof V&&(e=e.ele),e instanceof Element)for(;s;){if(s.ele==e)return!0;s=s.parent}return!1}for(;s;)K(s.ele,e)&&t.push(s),s=s.parent}else for(;s;)t.push(s),s=s.parent;return t}is(e){return K(this.ele,e)}attr(e,t){if(a(t)){if(!(e instanceof Object))return this.ele.getAttribute(e);Object.keys(e).forEach(t=>{this.attr(t,e[t])})}else if(this.xvRender){R.get(this.tag).attrs.includes(e)&&(this[e]=t)}else this.ele.setAttribute(e,t)}removeAttr(e){return this.ele.removeAttribute(e),this}}window.XhearEle=V,["concat","every","filter","find","findIndex","forEach","map","slice","some","indexOf","lastIndexOf","includes","join"].forEach(e=>{let t=Array.prototype[e];t&&Object.defineProperty(V.prototype,e,{value(...e){return t.apply(Array.from(this.ele.children).map(e=>Z(e)[j]),e)}})}),Object.defineProperties(V,{push(){},splice(){}});const R=new Map,z=(e,t)=>{let s=Z(e);Object.defineProperty(e,"xvele",{value:!0}),Object.defineProperty(s,"xvele",{value:!0});let{proto:r}=t;r&&Object.keys(r).forEach(e=>{let{get:t,set:a,value:i}=Object.getOwnPropertyDescriptor(r,e);i?Object.defineProperty(s,e,{value:i}):Object.defineProperty(s,e,{get:t,set:a})});let n=e.attachShadow({mode:"open"});n.innerHTML=t.temp,Array.from(n.querySelectorAll("[xv-tar]")).forEach(e=>{let t=e.getAttribute("xv-tar");Object.defineProperty(s,"$"+t,{value:Z(e)})}),Array.from(n.querySelectorAll("xv-span")).forEach(e=>{var t=document.createTextNode("");e.parentNode.insertBefore(t,e),e.parentNode.removeChild(e);var r=e.getAttribute("xvkey");s.watch(r,e=>t.textContent=s[r])}),s.watch(t.watch);let l=Object.assign({},t.data);t.attrs.forEach(t=>{let r=e.getAttribute(t);a(r)||null==r||(l[t]=r),s.watch(t,s=>{e.setAttribute(t,s.val)})}),t.props.forEach(t=>{let s=e.getAttribute(t);!a(s)&&null!=s&&(l[t]=s)});let c=Object.keys(l);c.push(...t.attrs),c.push(...t.props),c.push(...Object.keys(t.watch)),c=new Set(c),Object.defineProperty(s,$,{value:c}),c.forEach(e=>{let t=l[e];t instanceof Object&&(t=i(t),t=d(t,{parent:s,hostkey:e})),a(t)||s.setData(e,t)})},Z=e=>e.__xhear__||new V(e);let F=e=>{if(e instanceof V)return e;let t;switch(r(e)){case"string":t=e.includes("<")?(e=>{let t=document.createElement("div");t.innerHTML=e;return Array.from(t.childNodes).filter(function(e){if(!(e instanceof Text)||e.textContent&&e.textContent.trim())return t.removeChild(e),e})})(e):document.querySelector(e);break;case"object":t=N(e);break;default:e instanceof Element&&(t=e)}return t?Z(t)[j]:null};Object.assign(F,{register:e=>{let t={tag:"",temp:"",attrs:[],props:[],data:{},watch:{},unBubble:[],update:!0};Object.assign(t,e);let s=t.attrs=t.attrs.map(e=>U(e));t.props=t.props.map(e=>U(e)),t.unBubble=t.unBubble.map(e=>U(e)),t.data=i(t.data),t.watch=Object.assign({},t.watch);let r=t.tag=U(t.tag);if(t.temp){let{temp:e}=t;var a=(e=e.replace(/<!--.+?-->/g,"")).match(/{{.+?}}/g);a&&a.forEach(t=>{var s=/{{(.+?)}}/.exec(t);s&&(e=e.replace(t,`<xv-span xvkey="${s[1].trim()}"></xv-span>`))}),t.temp=e}let n=class extends HTMLElement{constructor(){super(),z(this,t),t.inited&&t.inited.call(this)}connectedCallback(){t.attached&&t.attached.call(this)}disconnectedCallback(){t.detached&&t.detached.call(this)}attributeChangedCallback(e,t,s){let r=this.__xhear__;s!=r[e]&&(r[e]=s)}static get observedAttributes(){return s}};Object.assign(t,{XhearElement:n}),R.set(t.tag,t),customElements.define(r,n)}}),e.$=F})(window);